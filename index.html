<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Travis&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Travis's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Travis's Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Travis's Blog">
  
    <link rel="alternate" href="https://github.com/hengsongji/" title="Travis&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Travis&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">不忘初心 砥砺前行</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
       <!-- <a id="nav-rss-link" class="nav-icon" href="https://github.com/hengsongji/" title="github"></a>-->
       	    <!-- <a href="https://github.com/hengsongji/" title="Github" target="_blank"><i class="nav-icon iconfont icon-github"></i></a>-->
        
      </nav>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Retrofit详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/Retrofit详解/" class="article-date">
  <time datetime="2017-03-27T07:46:30.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/Retrofit详解/">Retrofit详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>参考:<br><a href="http://square.github.io/retrofit/" target="_blank" rel="external">Retrofit官方介绍</a></p>
<p>首先我们根据官方介绍写一个Demo，然后跟踪一次HTTP请求，参观一遍Retrofit的实现过程。</p>
<h2 id="写一个Demo"><a href="#写一个Demo" class="headerlink" title="写一个Demo"></a>写一个Demo</h2><ol>
<li><p>使用Retrofit时，你需要把HTTP API转化为Java接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</div><div class="line">  <span class="meta">@GET</span>(<span class="string">"users/&#123;user&#125;/repos"</span>)</div><div class="line">  Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path</span>(<span class="string">"user"</span>) String user);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Retrofit生成一个实现GitHubService接口的实体类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">  .baseUrl(<span class="string">"https://api.github.com/"</span>)</div><div class="line">  .build();</div><div class="line"></div><div class="line">GitHubService service = retrofit.create(GitHubService.class);</div></pre></td></tr></table></figure>
</li>
<li><p>再由上述service生成Call对象就可以同步/异步执行HTTP请求了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Call&lt;List&lt;Repo&gt;&gt; repos = service.listRepos(<span class="string">"octocat"</span>);</div></pre></td></tr></table></figure>
</li>
</ol>
<p>以上是使用方法的官方介绍(只列出了主要步骤)，下面是我据此实现的一个Demo。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RetrofitDemo</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BASE_URL=<span class="string">"https://api.github.com/"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</div><div class="line">        <span class="meta">@GET</span>(<span class="string">"users/&#123;user&#125;/repos"</span>)</div><div class="line">        Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path</span>(<span class="string">"user"</span>) String user);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Repo</span></span>&#123;</div><div class="line">        <span class="keyword">public</span> String id;</div><div class="line">        <span class="keyword">public</span> String name;</div><div class="line">        <span class="meta">@SerializedName</span>(<span class="string">"full_name"</span>)</div><div class="line">        <span class="keyword">public</span> String fullName;</div><div class="line">        <span class="comment">//...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">                .baseUrl(BASE_URL)</div><div class="line">                .addConverterFactory(GsonConverterFactory.create())</div><div class="line">                .build();</div><div class="line">        GitHubService service = retrofit.create(GitHubService.class);</div><div class="line">        Call&lt;List&lt;Repo&gt;&gt; repos = service.listRepos(<span class="string">"square"</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Response&lt;List&lt;Repo&gt;&gt; response = repos.execute();</div><div class="line">            System.out.println(response.body().size());</div><div class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从这个Demo我们就可以看出Retrofit的优越性：</p>
<ul>
<li>封装了几乎所有的网络操作，把使用者从大量繁琐且重复的工作中解放出来；</li>
<li>业务逻辑简洁明了，提高了代码的可读性；</li>
<li>面向接口编程，提供了高扩展性。</li>
</ul>
<h2 id="跟随HTTP请求，洞悉Retrofit的内部世界"><a href="#跟随HTTP请求，洞悉Retrofit的内部世界" class="headerlink" title="跟随HTTP请求，洞悉Retrofit的内部世界"></a>跟随HTTP请求，洞悉Retrofit的内部世界</h2><p>以下内容以上述Demo为样例。</p>
<p>我们可以看到就是下面的代码执行了HTTP请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">repos.execute()</div></pre></td></tr></table></figure>
<p>在跟踪execute方法之前，我们先来看一下repos的身世：我们调用GitHubService的接口方法返回了一个Call<list<repo>&gt;对象，即repos。也就是说，这里的service实现了GitHubService接口。相信你看到这里也和我一样，一脸懵。下面我们就看看这个service是怎么生成的，为什么它能够返回一个Call<list<repo>&gt;对象。</list<repo></list<repo></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Retrofit.java 仅展示相关代码</span></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123; service &#125;,</div><div class="line">        <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line"></div><div class="line">          <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></div><div class="line">              <span class="keyword">throws</span> Throwable &#123;</div><div class="line">            ...</div><div class="line">            ServiceMethod&lt;Object, Object&gt; serviceMethod =</div><div class="line">                (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);</div><div class="line">            OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">            <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>原来是利用Java Proxy生成了GitHubService的实现类，并生成了该类对应的对象。关于Java Proxy的知识还请自行百度，这里只大概讲一下。</p>
<p>这个方法的原型是：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span></span></div></pre></td></tr></table></figure></p>
<p>动态代理其实就是java.lang.reflect.Proxy类动态地根据指定的接口生成一个class byte，该class会继承Proxy类，并实现所有你指定的接口（您在参数中传入的接口数组）；然后再利用指定的ClassLoader将class byte加载进系统，最后生成这样一个类的对象，并初始化该对象的一些值，如InvocationHandler,以及所有的接口对应的Method成员。 初始化之后将对象返回给调用的客户端。这样客户端拿到的就是一个实现你所有的接口的Proxy对象。</p>
<p>我们做个简单的总结，Retrofit.create方法生成了GitHubService的代理对象service，service中的所有方法都交由InvocationHandler来处理。也就是说，InvocationHandler.invoke方法形成了一个切面，承载了GitHubService中所有方法的具体实现。</p>
<p>再来看下InvocationHandler.invoke都做了些什么工作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function">Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></div><div class="line">    <span class="keyword">throws</span> Throwable &#123;</div><div class="line">  ...</div><div class="line">  ServiceMethod&lt;Object, Object&gt; serviceMethod =</div><div class="line">      (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);</div><div class="line">  OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">  <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看明白这里需要具备一点Java反射的知识，如果不太明白还请自行百度。简言之，就是<font color="#ff3131">根据反射获取到GitHubService所声明方法的注解、参数及类型、返回值类型，构造了一个HTTP任务：OkHttpCall</font>。下面是详细讲解，先来看下loadServiceMethod方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//仅展示相关代码</span></div><div class="line"><span class="comment">//Retrofit.java</span></div><div class="line">ServiceMethod&lt;?, ?&gt; loadServiceMethod(Method method) &#123;</div><div class="line">  <span class="comment">// 先在缓存中查找method对应的ServiceMethod</span></div><div class="line">  ServiceMethod&lt;?, ?&gt; result = serviceMethodCache.get(method);</div><div class="line">  <span class="comment">// 已经在缓存中了，直接返回</span></div><div class="line">  <span class="keyword">if</span> (result != <span class="keyword">null</span>) <span class="keyword">return</span> result;</div><div class="line"></div><div class="line">  <span class="keyword">synchronized</span> (serviceMethodCache) &#123;</div><div class="line">    result = serviceMethodCache.get(method);</div><div class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">// 没有在当前的缓存中，以method为参数创建一个ServiceMethod，并放入缓存中</span></div><div class="line">      result = <span class="keyword">new</span> ServiceMethod.Builder&lt;&gt;(<span class="keyword">this</span>, method).build();</div><div class="line">      serviceMethodCache.put(method, result);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ServiceMethod.java</span></div><div class="line"><span class="comment">//建造器模式，把复杂对象的构建独立出来</span></div><div class="line">Builder(Retrofit retrofit, Method method) &#123;</div><div class="line">  <span class="keyword">this</span>.retrofit = retrofit;</div><div class="line">  <span class="keyword">this</span>.method = method;</div><div class="line">  <span class="keyword">this</span>.methodAnnotations = method.getAnnotations();</div><div class="line">  <span class="keyword">this</span>.parameterTypes = method.getGenericParameterTypes();</div><div class="line">  <span class="keyword">this</span>.parameterAnnotationsArray = method.getParameterAnnotations();</div><div class="line">&#125;</div><div class="line"><span class="comment">//开始构建</span></div><div class="line"><span class="function"><span class="keyword">public</span> ServiceMethod <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">/* 生成调用适配器，这里之所以采用适配器模式，是因为Retrofit的Http框架(默认是OKHttp)也是可配的</span></div><div class="line">  */</div><div class="line">  callAdapter = createCallAdapter();</div><div class="line">  <span class="comment">//解析返回值类型</span></div><div class="line">  responseType = callAdapter.responseType();</div><div class="line">  ...</div><div class="line">  <span class="comment">// 用以解析返回数据</span></div><div class="line">  responseConverter = createResponseConverter();</div><div class="line">  <span class="comment">// 解析method的注解，注解里面封装了API信息</span></div><div class="line">  <span class="keyword">for</span> (Annotation annotation : methodAnnotations) &#123;</div><div class="line">    parseMethodAnnotation(annotation);</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">  <span class="keyword">int</span> parameterCount = parameterAnnotationsArray.length;</div><div class="line">  parameterHandlers = <span class="keyword">new</span> ParameterHandler&lt;?&gt;[parameterCount];</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; parameterCount; p++) &#123;</div><div class="line">    Type parameterType = parameterTypes[p];</div><div class="line">    ...</div><div class="line">    Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</div><div class="line">    ...</div><div class="line">    <span class="comment">//解析入参</span></div><div class="line">    parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//构造ServiceMethod</span></div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethod&lt;&gt;(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">// builder已经准备好了所有需要的信息，ServiceMethod坐享其成</span></div><div class="line">ServiceMethod(Builder&lt;R, T&gt; builder) &#123;</div><div class="line">    <span class="keyword">this</span>.callFactory = builder.retrofit.callFactory();</div><div class="line">    <span class="keyword">this</span>.callAdapter = builder.callAdapter;</div><div class="line">    <span class="keyword">this</span>.baseUrl = builder.retrofit.baseUrl();</div><div class="line">    <span class="keyword">this</span>.responseConverter = builder.responseConverter;</div><div class="line">    <span class="keyword">this</span>.httpMethod = builder.httpMethod;</div><div class="line">    <span class="keyword">this</span>.relativeUrl = builder.relativeUrl;</div><div class="line">    <span class="keyword">this</span>.headers = builder.headers;</div><div class="line">    <span class="keyword">this</span>.contentType = builder.contentType;</div><div class="line">    <span class="keyword">this</span>.hasBody = builder.hasBody;</div><div class="line">    <span class="keyword">this</span>.isFormEncoded = builder.isFormEncoded;</div><div class="line">    <span class="keyword">this</span>.isMultipart = builder.isMultipart;</div><div class="line">    <span class="keyword">this</span>.parameterHandlers = builder.parameterHandlers;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>我们可以看到loadServiceMethod方法做了很多工作：提取请求方法POST/GET、提取请求的API、提取请求参数、提取返回参数类型、准备数据解析器。一个HTTP请求所需要的要素都已经具备了。</p>
<p>继续看OkHttpCall的构造方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">OkHttpCall(ServiceMethod&lt;T, ?&gt; serviceMethod, Object[] args) &#123;</div><div class="line">  <span class="comment">/*持有ServiceMethod，从这里看ServiceMethod更像是数据单元，封装了网络请求的具体参数;而OkHttpCall则封装了HTTP任务*/</span></div><div class="line">  <span class="keyword">this</span>.serviceMethod = serviceMethod;</div><div class="line">  <span class="keyword">this</span>.args = args;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续看serviceMethod.callAdapter.adapt(okHttpCall)，之前loadServiceMethod执行时，已经创建了callAdapter。样例中的callAdapter就是Retrofit默认的，如果你在初始化Retrofit是配置了CallAdapter.Factory，那么Retrofit就会调用你所配置的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultCallAdapterFactory</span> <span class="keyword">extends</span> <span class="title">CallAdapter</span>.<span class="title">Factory</span> </span>&#123;</div><div class="line">  <span class="keyword">static</span> <span class="keyword">final</span> CallAdapter.Factory INSTANCE = <span class="keyword">new</span> DefaultCallAdapterFactory();</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</div><div class="line">    <span class="keyword">if</span> (getRawType(returnType) != Call.class) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Type responseType = Utils.getCallResponseType(returnType);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CallAdapter&lt;Object, Call&lt;?&gt;&gt;() &#123;</div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Type <span class="title">responseType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> responseType;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Call&lt;Object&gt; <span class="title">adapt</span><span class="params">(Call&lt;Object&gt; call)</span> </span>&#123;</div><div class="line">        <span class="comment">// 使用DefaultCallAdapterFactory仅仅是把OkHttpCall转发出去</span></div><div class="line">        <span class="keyword">return</span> call;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>综上分析，InvocationHandler.invoke方法根据所调用接口方法的注解、返回值类型、参数类型及参数构造了一个HTTP任务，即OkHttpCall。</p>
<p>然后再回到最初调用repos.execute，其实就是对OkHttpCall.execute的调用了，这里比较简单，不再展开讲了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/Retrofit详解/" data-id="cj0vb5b2n001ovqjh75xvkg1f" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Retrofit中的Json解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/14/Retrofit中的Json解析/" class="article-date">
  <time datetime="2017-03-14T14:51:05.000Z" itemprop="datePublished">2017-03-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/14/Retrofit中的Json解析/">Retrofit中的Json解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>下面是我使用Retrofit的一个例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> QYService service;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        OkHttpClient client = <span class="keyword">new</span> OkHttpClient.Builder()</div><div class="line">                .retryOnConnectionFailure(<span class="keyword">true</span>)</div><div class="line">                .connectTimeout(<span class="number">10L</span>, TimeUnit.SECONDS)</div><div class="line">                .build();</div><div class="line"></div><div class="line">        Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">                .baseUrl(QYService.BASE_URL)</div><div class="line">                .client(client)</div><div class="line">                .addConverterFactory(GsonConverterFactory.create())</div><div class="line">                .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</div><div class="line">                .build();</div><div class="line"></div><div class="line">        service = retrofit.create(QYService.class);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>今天我要讲的就是addConverterFactory这一行——Retrofit是如何解析Json数据的。</p>
<h2 id="Json字符串到Java对象"><a href="#Json字符串到Java对象" class="headerlink" title="Json字符串到Java对象"></a>Json字符串到Java对象</h2><p>我们看一下GsonConverterFactory的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GsonConverterFactory</span> <span class="keyword">extends</span> <span class="title">Converter</span>.<span class="title">Factory</span> </span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Create an instance using a default &#123;<span class="doctag">@link</span> Gson&#125; instance for conversion. Encoding to JSON and</div><div class="line">   * decoding from JSON (when no charset is specified by a header) will use UTF-8.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GsonConverterFactory <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> create(<span class="keyword">new</span> Gson());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Create an instance using &#123;<span class="doctag">@code</span> gson&#125; for conversion. Encoding to JSON and</div><div class="line">   * decoding from JSON (when no charset is specified by a header) will use UTF-8.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GsonConverterFactory <span class="title">create</span><span class="params">(Gson gson)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GsonConverterFactory(gson);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Gson gson;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">GsonConverterFactory</span><span class="params">(Gson gson)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (gson == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"gson == null"</span>);</div><div class="line">    <span class="keyword">this</span>.gson = gson;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations,</div><div class="line">      Retrofit retrofit) &#123;</div><div class="line">    TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type));</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GsonResponseBodyConverter&lt;&gt;(gson, adapter);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> Converter&lt;?, RequestBody&gt; requestBodyConverter(Type type,</div><div class="line">      Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit) &#123;</div><div class="line">    TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type));</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GsonRequestBodyConverter&lt;&gt;(gson, adapter);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到GsonConverterFactory提供了两个方法<code>responseBodyConverter</code>、<code>requestBodyConverter</code>。从名字其实就能猜测出，前者是解析response的，后者是解析request的。我们单追踪前者，就是这两行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type));</div><div class="line"><span class="keyword">return</span> <span class="keyword">new</span> GsonResponseBodyConverter&lt;&gt;(gson, adapter);</div></pre></td></tr></table></figure></p>
<p>这里有一个TypeAdapter没有见过，后面的TypeToken倒是旧相识了。追踪Gson源码我们发现：在构建Gson时，为Gson注册了很多TypeAdapterFactory，就是这些TypeAdapterFactory为Gson提供了解析各种数据的能力。其中这一行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">factories.add(<span class="keyword">new</span> ReflectiveTypeAdapterFactory(</div><div class="line">        constructorConstructor, fieldNamingStrategy, excluder, jsonAdapterFactory));</div></pre></td></tr></table></figure></p>
<p>就提供了解析自定义复杂对象的能力。这里不再展开讲了，有兴趣的话可以了解一下此处的源码，我们只需要知道这么一点就够了：TypeAdapter封装了Json字符串到Java对象的映射关系，能够把Java字符串解析成Java对象。</p>
<p>我们在来看GsonResponseBodyConverter的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GsonResponseBodyConverter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">ResponseBody</span>, <span class="title">T</span>&gt; </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Gson gson;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TypeAdapter&lt;T&gt; adapter;</div><div class="line"></div><div class="line">  GsonResponseBodyConverter(Gson gson, TypeAdapter&lt;T&gt; adapter) &#123;</div><div class="line">    <span class="keyword">this</span>.gson = gson;</div><div class="line">    <span class="keyword">this</span>.adapter = adapter;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> T <span class="title">convert</span><span class="params">(ResponseBody value)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    JsonReader jsonReader = gson.newJsonReader(value.charStream());</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">return</span> adapter.read(jsonReader);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      value.close();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个类提供了一个convert方法最终把Response解析成我们需要Java对象。</p>
<h2 id="Retrofit调用GsonConverterFactory"><a href="#Retrofit调用GsonConverterFactory" class="headerlink" title="Retrofit调用GsonConverterFactory"></a>Retrofit调用GsonConverterFactory</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//retrofit2.Retrofit 仅列出相关代码</span></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123; service &#125;,</div><div class="line">        <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">          ...</div><div class="line">          <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></div><div class="line">              <span class="keyword">throws</span> Throwable &#123;</div><div class="line">            ...</div><div class="line">            ServiceMethod&lt;Object, Object&gt; serviceMethod =</div><div class="line">                (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);</div><div class="line">            OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">            <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>我们发现最终的网络请求是OkHttpCall完成的，我们继续追踪OkHttpCall<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//retrofit2.OkHttpCall  仅列出相关代码</span></div><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response&lt;T&gt; <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    okhttp3.Call call;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> parseResponse(call.execute());</div><div class="line">  &#125;</div><div class="line"><span class="comment">//解析response  </span></div><div class="line"><span class="function">Response&lt;T&gt; <span class="title">parseResponse</span><span class="params">(okhttp3.Response rawResponse)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    ResponseBody rawBody = rawResponse.body();</div><div class="line">    ...</div><div class="line">    ExceptionCatchingRequestBody catchingBody = <span class="keyword">new</span> ExceptionCatchingRequestBody(rawBody);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      T body = serviceMethod.toResponse(catchingBody);</div><div class="line">      <span class="keyword">return</span> Response.success(body, rawResponse);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line"><span class="comment">/** Builds a method return value from an HTTP response body. */</span></div><div class="line"> <span class="function">R <span class="title">toResponse</span><span class="params">(ResponseBody body)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">   <span class="keyword">return</span> responseConverter.convert(body);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>至此Retrofit解析Json的脉络就很清晰了:Retrofit调用了OkHttpCall执行网络请求，获得网络返回之后调用早前注册的GsonConverterFactory中的GsonResponseBodyConverter解析网络数据。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/14/Retrofit中的Json解析/" data-id="cj0vb5b2c001dvqjh5rgcni77" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Json/">Json</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android应用内开新进程的一些行为记录" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/20/Android应用内开新进程的一些行为记录/" class="article-date">
  <time datetime="2017-02-20T09:03:31.000Z" itemprop="datePublished">2017-02-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/20/Android应用内开新进程的一些行为记录/">Android应用内开新进程的一些行为记录</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><p>直接在Manifest文件当中设置<code>android:process=&quot;:browser&quot;</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span></span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">".activity.BrowserActivity"</span></div><div class="line">    <span class="attr">android:screenOrientation</span>=<span class="string">"portrait"</span></div><div class="line">    <span class="attr">android:process</span>=<span class="string">":browser"</span>&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这样启动BrowserActivity之后，Activity就在一个新的进程当中了。</p>
</li>
<li><p>新进程的Application和原来的Application是什么关系？</p>
<p>新进程Application和原Application是同一个类，但已经是不同的对象了，并且静态成员也不一样了。</p>
</li>
<li><p>在新进程里面启动一个不带<code>process</code>属性的Activity，Activity运行在哪个进程中？</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="tag">&lt;<span class="name">activity</span></span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">".test.TestActivity"</span></div><div class="line">    <span class="attr">android:screenOrientation</span>=<span class="string">"portrait"</span>&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div></pre></td></tr></table></figure>
<p>测试发现：TestActivity运行在原进程当中</p>
</li>
<li><p>原进程退出之后，新进程能否继续运行？</p>
<p>是！</p>
<p>但是如果用户调用最近任务栏，清空最近任务，新进程也会被杀死！</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/02/20/Android应用内开新进程的一些行为记录/" data-id="cj0vb5b180009vqjhfel8u4qg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-system/">Android system</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ViewPager+Fragments+LazyLoad" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/13/ViewPager+Fragments+LazyLoad/" class="article-date">
  <time datetime="2017-02-13T13:56:08.000Z" itemprop="datePublished">2017-02-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/13/ViewPager+Fragments+LazyLoad/">ViewPager+Fragments+LazyLoad</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ViewPager+Fragments可以帮助Android开发者方便地实现多个tab页之间的切换。可是在使用中你有没有遇到过一些不是那么美丽的状况呢？比方说，进入页面的前几秒钟特别卡顿？从别的页面切换回来，竟然重新加载了页面？从网上Copy了LazyLoad代码下来，来回切换了几次崩溃了？WTF！！！ViewPager+Fragments用起来并不复杂，不消十分钟你就可以把它引入项目，但是要想获得好的体验，就要多花一点功夫了。这篇文章，我就记录一下自己在开发过程中使用到的优化方法。</p>
<p>##LazyLoad</p>
<p>首先我们来复习一下ViewPager的基础知识(使用FragmentAdapter)。ViewPager默认至多预加载2个Fragment(可见页面称为VisibleFragment，可见页面左右各一个InvisibleFragment)，至少预加载一个页面(可见页面是第一个，仅在右侧有一个InvisibleFragment)。也就是说，我们第一次进入页面时，ViewPager至少加载了两个Fragment，一个VisibleFragment，一个InvisibleFragment。如果InvisibleFragment有什么耗时操作，就会连累VisibleFragment特别卡顿。</p>
<p>聪明如你肯定会想，这个问题so easy，调用一下<code>ViewPager.setOffscreenPageLimit(0)</code>，禁止ViewPager预加载不就ok了嘛！naive！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOffscreenPageLimit</span><span class="params">(<span class="keyword">int</span> limit)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (limit &lt; DEFAULT_OFFSCREEN_PAGES) &#123;</div><div class="line">          Log.w(TAG, <span class="string">"Requested offscreen page limit "</span> + limit + <span class="string">" too small; defaulting to "</span> +</div><div class="line">                  DEFAULT_OFFSCREEN_PAGES);</div><div class="line">          limit = DEFAULT_OFFSCREEN_PAGES;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (limit != mOffscreenPageLimit) &#123;</div><div class="line">          mOffscreenPageLimit = limit;</div><div class="line">          populate();</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>从<code>ViewPager.setOffscreenPageLimit(int limit)</code>方法的源码，可以看到预加载页面至少是<code>DEFAULT_OFFSCREEN_PAGES</code>,这个值是1。</p>
<p>你可能又会想了，<font color="#ff3131">InvisibleFragment页面从不可见转为可见，这个状态肯定能够捕捉到吧，在页面变为可见的时候执行耗时操作不就可以了嘛</font>！对头！！！这个方法就是Fragment.setUserVisibleHint(boolean isVisibleToUser),一旦Fragment可见状态发生变化，这个方法就会被调用。所以我们就可以这样写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 是否已加载数据</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mLoaded = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 一旦页面可见性发生变化，这个方法就会被调用</div><div class="line"> * 当页面可见且数据未加载时，加载数据</div><div class="line"> * <span class="doctag">@param</span> isVisibleToUser</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserVisibleHint</span><span class="params">(<span class="keyword">boolean</span> isVisibleToUser)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.setUserVisibleHint(isVisibleToUser);</div><div class="line">    <span class="keyword">if</span> (isVisibleToUser &amp;&amp; !mLoaded) &#123;</div><div class="line">        mLoaded = <span class="keyword">true</span>;</div><div class="line">        loadData();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个就是所谓的LazyLoad！</p>
<p>学到上面的新技能之后你兴冲冲地去实验，编码&gt;&gt;运行&gt;&gt;不错呀！写博客的小哥没骗我！&gt;&gt;纳尼！崩溃了！这个死骗子，肯定拿假的LazyLoad来骗我，看我不骂死他！看官大爷请息怒！我真没骗你，不信咱们接着往下看！</p>
<p>这个地方的崩溃应该是NullPointerException，提示在View初始化之前即对其进行了操作。看来setUserVisibleHint()方法被调用时，onCreateView()方法还没有被调用。要解决这个问题我们要首先弄清楚Fragment中相关方法被调用的顺序(你可以在自己项目中把方法的调用都打印出来)。</p>
<p>然后我们发现Fragment中相关方法的调用顺序是这个样子的：<br>setUserVisibleHint()&gt;&gt;onCreateView()&gt;&gt;onActivityCreated()。</p>
<p>setUserVisibleHint()确实是在onCreateView()之前被调用的，这可怎么办呀？表怂呀！这还能难得住你？添加一个全局变量，标识onCreateView()方法是否被调用，如果没有被调用，setUserVisibleHint()不执行加载数据的操作。然后我们还需要在onActivityCreated()里面二次判断是否首次加载。现在代码长这个样子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * onCreateView()是否被调用</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mOnCreateViewInvoked = <span class="keyword">false</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 是否已加载数据</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mLoaded = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 一旦页面可见性发生变化，这个方法就会被调用</div><div class="line"> * 当onCreateView()已经被调用&amp;&amp;页面可见&amp;&amp;数据未加载时，加载数据</div><div class="line"> * <span class="doctag">@param</span> isVisibleToUser</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserVisibleHint</span><span class="params">(<span class="keyword">boolean</span> isVisibleToUser)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.setUserVisibleHint(isVisibleToUser);</div><div class="line">    <span class="keyword">if</span> (mOnCreateViewInvoked &amp;&amp; isVisibleToUser &amp;&amp; !mLoaded) &#123;</div><div class="line">        mLoaded = <span class="keyword">true</span>;</div><div class="line">        loadData();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="meta">@Nullable</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    mOnCreateViewInvoked = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">// your code</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 二次测试是否首次加载</div><div class="line"> * <span class="doctag">@param</span> savedInstanceState</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</div><div class="line">    <span class="keyword">if</span> (getUserVisibleHint() &amp;&amp; !mLoaded) &#123;</div><div class="line">        mLoaded = <span class="keyword">true</span>;</div><div class="line">        loadData();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你再试试，现在是不是不崩溃了！我跟你讲了，我写的是真的LazyLoad！</p>
<p>刷了一会儿你又发现问题了，从别的页面返回之后咋又重新加载数据了？在tab页中，我们可能并不希望，页面每次可见的时候数据都重新加载一遍，而是只在第一次可见的时候加载。看官大爷您这个需求比较简单，只需要一行代码就可以搞定了。我们只需要在ViewPager初始化的时候添加一行设置ViewPager.setOffscreenPageLimit(sizeOfFragments)。这样ViewPager中所有的Framgment都不会被回收了，陪你到天荒地老！</p>
<p>接下来写一篇文章介绍一下两个ViewPager嵌套时，Fragment可见性的判断。</p>
<p>完！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/02/13/ViewPager+Fragments+LazyLoad/" data-id="cj0vb5b2e001fvqjho0iys342" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-system/">Android system</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-后台应用被系统回收后重启" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/25/后台应用被系统回收后重启/" class="article-date">
  <time datetime="2017-01-25T07:02:16.000Z" itemprop="datePublished">2017-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/25/后台应用被系统回收后重启/">后台应用被系统回收后重启</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>如果系统内存不足、或者切换横竖屏、或者App长时间在后台运行，Activity都可能被系统回收，然后Frament并不会随着Activity<br>的回收而被回收，从而导致Fragment丢失了对应的Activity。</p>
<p>原来Activity切换到后台之后，由于系统内存不够，Activity被系统回收了，一段时间之后回到应用程序，Activity被重新实例化了。而Activity被系统销毁时，附属在该Activity的Fragment并没有被销毁，在Activity的onSaveInstanceState里面将Fragment的状态保存起来了，所以Activity重新创建了，但是Fragment还是之前的，他们持有的Activity已经被系统回收了。</p>
<p>解决方法：<br>在基类中重写onSaveInstanceState方法，并且注释掉super.onSaveInstanceState(outState)就可以了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/25/后台应用被系统回收后重启/" data-id="cj0vb5b2o001qvqjhqri9cb13" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-system/">Android system</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Looper和Handler类" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/20/Looper和Handler类/" class="article-date">
  <time datetime="2017-01-20T15:06:21.000Z" itemprop="datePublished">2017-01-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/20/Looper和Handler类/">Looper和Handler类</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Handler原理分析"><a href="#Handler原理分析" class="headerlink" title="Handler原理分析"></a>Handler原理分析</h2><p>了解Looper和Handler可以参考以下文章：<br><br><a href="http://blog.csdn.net/u013435893/article/details/50903082" target="_blank" rel="external">《Android中为什么主线程不会因为Looper.loop()方法造成阻塞》</a></p>
<p>就应用程序而言，Android系统中java的应用程序和其它系统上相同，都是靠消息驱动来工作的，它们大致的工作原理如下：</p>
<ol>
<li>有一个消息队列，可以往这个消息队列中投递消息。</li>
<li>有一个消息循环，不断的从消息队列中取出消息，然后处理。</li>
</ol>
<p>下面的图示即可展示这个工作过程。<br><img src="消息队列示意图.png" width="480/"></p>
<p>从图中可以看出：</p>
<ol>
<li><p>事件源把待处理的消息加入到消息队列中，一般是加至队列尾，一些优先级高的消息也可以加至队列头。事件源提交的消息可以是按键、触摸屏等物理时间产生的消息，也可以是系统或应用程序本身发出的请求消息。</p>
</li>
<li><p>处理线程不断的从消息队列头部取出消息并处理，事件源可以把优先级高的消息放到消息头，这样优先级高的消息就会首先被处理。</p>
</li>
</ol>
<p>在Android系统中，这些工作主要由Looper和Handler来实现：<br>Looper类，用于封装消息循环，并且有一个消息队列。</p>
<p>Handler类，有点像辅助类，它封装了消息投递、消息处理等接口。</p>
<p>Looper类是其中的关键。先来看看它是怎么做的。</p>
<h2 id="Looper类的分析"><a href="#Looper类的分析" class="headerlink" title="Looper类的分析"></a>Looper类的分析</h2><p>我们以Looper使用的一个常见例子来分析这个Looper类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> Handler mHandler;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="comment">// 调用prepare</span></div><div class="line">        Looper.prepare();</div><div class="line">        ...</div><div class="line">        <span class="comment">// 进入消息循环</span></div><div class="line">        Looper.loop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的两处注释就是Looper使用的关键步骤，我们逐一进行分析。</p>
<ol>
<li><p>准备好了吗？</p>
<p>第一个函数是Looper的prepare函数。它会做什么工作呢？<br>代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Looper.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">    <span class="comment">// 一个Looper只能调用一次prepare</span></div><div class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</div><div class="line">    &#125;</div><div class="line">      <span class="comment">//构造一个Looper对象，设置到调用线程的局部变量中</span></div><div class="line">    sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</div><div class="line">&#125;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal sThreadLocal = <span class="keyword">new</span> ThreadLocal();</div></pre></td></tr></table></figure>
<p>ThreadLocal是java中的线程局部变量类，全名应该是ThreadLocalVariable。该类有两个关键函数：</p>
<ul>
<li>set:设置调用县城的局部变量；</li>
<li>get:获取调用线程的局部变量。</li>
</ul>
<p>根据上面的分析可知，prepare会在调用线程的局部变量中设置一个Looper对象。这个调用线程就是LooperThread的run线程。先看看Looper对象的构造，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="comment">//构造一个消息队列</span></div><div class="line">  mQueue = <span class="keyword">new</span> MessageQueue();</div><div class="line">  mRun = <span class="keyword">true</span>;</div><div class="line">  <span class="comment">//得到当前线程的Thread对象</span></div><div class="line">  mThread = Thread.currentThread();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>prepare函数很简单，它主要干了一件事：<br>在调用prepare的线程中，设置了一个Looper对象，这个Looper对象就保存在这个调用线程的ThreadLocalVariable中。而Looper对象内部封装了一个消息队列。</p>
<p>也就是说，prepare函数通过ThreadLocal机制，巧妙地把Looper和调用线程关联在一起了。要了解这样做的目的是什么，需要再看第二个重要函数。</p>
</li>
<li><p>Looper循环<br>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"> * Run the message queue in this thread. Be sure to call</div><div class="line"> * &#123;<span class="doctag">@link</span> #quit()&#125; to end the loop.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Looper me = myLooper();</div><div class="line">    <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">final</span> MessageQueue queue = me.mQueue;</div><div class="line"></div><div class="line">    <span class="comment">// Make sure the identity of this thread is that of the local process,</span></div><div class="line">    <span class="comment">// and keep track of what that identity token actually is.</span></div><div class="line">    Binder.clearCallingIdentity();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        Message msg = queue.next(); <span class="comment">// might block</span></div><div class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// No message indicates that the message queue is quitting.</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></div><div class="line">        <span class="keyword">final</span> Printer logging = me.mLogging;</div><div class="line">        <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">            logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</div><div class="line">                    msg.callback + <span class="string">": "</span> + msg.what);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> traceTag = me.mTraceTag;</div><div class="line">        <span class="keyword">if</span> (traceTag != <span class="number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</div><div class="line">            Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            msg.target.dispatchMessage(msg);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</div><div class="line">                Trace.traceEnd(traceTag);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">            logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Make sure that during the course of dispatching the</span></div><div class="line">        <span class="comment">// identity of the thread wasn't corrupted.</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</div><div class="line">        <span class="keyword">if</span> (ident != newIdent) &#123;</div><div class="line">            Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></div><div class="line">                    + Long.toHexString(ident) + <span class="string">" to 0x"</span></div><div class="line">                    + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></div><div class="line">                    + msg.target.getClass().getName() + <span class="string">" "</span></div><div class="line">                    + msg.callback + <span class="string">" what="</span> + msg.what);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        msg.recycleUnchecked();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"> * Return the Looper object associated with the current thread.  Returns</div><div class="line"> * null if the calling thread is not associated with a Looper.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> sThreadLocal.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上面的分析，Looper的作用是：</p>
<ul>
<li>封装了一个消息队列。</li>
<li>Looper的prepare函数把这个Looper和调用prepare的线程(也就是最终的处理线程)绑定在一起了。</li>
<li>处理线程调用loop函数，处理来自该消息队列的消息。</li>
</ul>
<p>当事件源向这个Looper发送消息的时候，其实是把消息加到这个Looper的消息队列里了。那么，该消息就将有和Looper绑定的线程来处理。可事件源又是怎么向Looper消息队列中添加消息的呢？来看下一节。</p>
</li>
<li><p>Looper、Message和Handler的关系<br>Looper、Message、Handler三者之间的关系用两句话就能够说清楚：</p>
<ul>
<li>Looper中有一个Message消息队列，里面存储的是一个个待处理的Mesage。</li>
<li>Message中有一个Handler，这个Handler是用来处理Message的。</li>
</ul>
<p>其中Handler类封装了很多琐碎的工作。</p>
</li>
</ol>
<h2 id="Looper和Handler的同步关系"><a href="#Looper和Handler的同步关系" class="headerlink" title="Looper和Handler的同步关系"></a>Looper和Handler的同步关系</h2><p>Looper和Handler会有什么同步关系呢？它们之间确实存在同步关系，而且如果不注意此同步关系，定会铸成大错。</p>
<p>同步关系肯定与多线程有关系，我们来看下面一个例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//先定义一个LooperThread类</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">  <span class="comment">//定义一个public的成员myLooper，初值为空</span></div><div class="line">  <span class="keyword">public</span> Looper myLooper = <span class="keyword">null</span>;;</div><div class="line">  <span class="comment">//假设run在线程2中执行</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="comment">//myLooper必须在这个线程中赋值</span></div><div class="line">    myLooper = Looper.myLooper();</div><div class="line">    Looper.loop();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//下面这段代码在线程1中执行，并且会创建线程2</span></div><div class="line">LooperThread lpThred = <span class="keyword">new</span> LooperThread();</div><div class="line"><span class="comment">//start后会创建线程2</span></div><div class="line">lpThread.start();</div><div class="line"><span class="comment">//warn</span></div><div class="line">Looper looper = lpThread.myLooper;</div><div class="line"><span class="comment">//thread2Handler和线程2的Looper绑定</span></div><div class="line">Handler thread2Handler = <span class="keyword">new</span> Handler(looper);</div><div class="line"><span class="comment">//sendMessage发送的消息将有线程2处理</span></div><div class="line">thread2Handler.sendMessage();</div></pre></td></tr></table></figure></p>
<p>上面这段代码的目的非常简单：</p>
<ul>
<li>线程1中创建线程2，并且线程2通过Looper处理消息。</li>
<li>线程1中得到的线程2的Looper，并且根据这个Looper创建一个Handler，这样发送给该Handler的消息将由线程2处理。</li>
</ul>
<p>很可惜，上面的代码是有问题的。如果我们熟悉多线程，就会发现“warn”的那行代码存在严重的问题。myLooper的创建实在线程2中，而不是在线程1中，很有可能此时线程2的run函数还没来得及给myLooper赋值，这样线程1中的looper将取到myLooper的初值，也就是looper等于null。</p>
<p>对于这个问题，可以采用同步的方式完成处理。你是不是有点迫不及待地想完善这个例子了？其实Android早就替我们想好了，它提供了一个HandlerThread来解决这个问题。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HandlerThread.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    mTid = Process.myTid();</div><div class="line">    Looper.prepare();</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        mLooper = Looper.myLooper();</div><div class="line">        notifyAll();</div><div class="line">    &#125;</div><div class="line">    Process.setThreadPriority(mPriority);</div><div class="line">    onLooperPrepared();</div><div class="line">    Looper.loop();</div><div class="line">    mTid = -<span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * This method returns the Looper associated with this thread. If this thread not been started</div><div class="line"> * or for any reason is isAlive() returns false, this method will return null. If this thread</div><div class="line"> * has been started, this method will block until the looper has been initialized.  </div><div class="line"> * <span class="doctag">@return</span> The looper.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Looper <span class="title">getLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!isAlive()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If the thread has been started, wait until the looper has been created.</span></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">while</span> (isAlive() &amp;&amp; mLooper == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                wait();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> mLooper;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<font color="#ff3131">本文系邓凡平老师《深入理解Android(卷1)》节选。</font>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/20/Looper和Handler类/" data-id="cj0vb5b260018vqjhpfae80ji" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-system/">Android system</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-如何调试多文件上传" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/12/如何调试多文件上传/" class="article-date">
  <time datetime="2017-01-12T09:06:20.000Z" itemprop="datePublished">2017-01-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/12/如何调试多文件上传/">如何调试多文件上传</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="服务器如何设置？"><a href="#服务器如何设置？" class="headerlink" title="服务器如何设置？"></a>服务器如何设置？</h2><p>我调试的时候使用的是PHP服务器，只写一句话：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">print_r($_FILES);</div></pre></td></tr></table></figure>
<h2 id="App端如何设置？"><a href="#App端如何设置？" class="headerlink" title="App端如何设置？"></a>App端如何设置？</h2><p>客户端直接使用的是[okhttputils][1]，上传代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">OkHttpUtils.post()</div><div class="line">    .url(<span class="string">"http://192.168.1.28/demo/index.php"</span>)</div><div class="line">    .addFile(<span class="string">"file[]"</span>, paths.get(<span class="number">0</span>).substring(paths.get(<span class="number">0</span>).indexOf(<span class="string">"/"</span>)), <span class="keyword">new</span> File(paths.get(<span class="number">0</span>)))</div><div class="line">    .addFile(<span class="string">"file[]"</span>, paths.get(<span class="number">1</span>).substring(paths.get(<span class="number">1</span>).indexOf(<span class="string">"/"</span>)), <span class="keyword">new</span> File(paths.get(<span class="number">1</span>)))</div><div class="line">    .build()</div><div class="line">    .execute(<span class="keyword">new</span> StringCallback() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Call call, Exception e, <span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(String response, <span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">            Log.d(<span class="string">"MainActivity"</span>, <span class="string">"response="</span> + response);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"> * Try to return the absolute file path from the given Uri</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> context</div><div class="line"> * <span class="doctag">@param</span> uri</div><div class="line"> * <span class="doctag">@return</span> the file path or null</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRealFilePath</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> Uri uri)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == uri) <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">final</span> String scheme = uri.getScheme();</div><div class="line">    String data = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (scheme == <span class="keyword">null</span>)</div><div class="line">        data = uri.getPath();</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ContentResolver.SCHEME_FILE.equals(scheme)) &#123;</div><div class="line">        data = uri.getPath();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ContentResolver.SCHEME_CONTENT.equals(scheme)) &#123;</div><div class="line">        Cursor cursor = context.getContentResolver().query(uri, <span class="keyword">new</span> String[]&#123;MediaStore.Images.ImageColumns.DATA&#125;, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != cursor) &#123;</div><div class="line">            <span class="keyword">if</span> (cursor.moveToFirst()) &#123;</div><div class="line">                <span class="keyword">int</span> index = cursor.getColumnIndex(MediaStore.Images.ImageColumns.DATA);</div><div class="line">                <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) &#123;</div><div class="line">                    data = cursor.getString(index);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            cursor.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> data;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="联调："><a href="#联调：" class="headerlink" title="联调："></a>联调：</h2><p>如果得到以下返回则说明成功了</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">Array</div><div class="line">(</div><div class="line">  [file] =&gt; Array</div><div class="line">         (</div><div class="line">           [name] =&gt; Array</div><div class="line">                  (</div><div class="line">                    [0] =&gt; IMG_20161017_112752.jpg</div><div class="line">                    [1] =&gt; img-c6d422f96853ea6e7d73837b23d5fa3c.jpg</div><div class="line">                  )</div><div class="line"></div><div class="line">            [type] =&gt; Array</div><div class="line">                  (</div><div class="line">                     [0] =&gt;</div><div class="line">                     [1] =&gt; image/jpeg</div><div class="line">                  )</div><div class="line">            [tmp_name] =&gt; Array</div><div class="line">                      (</div><div class="line">                        [0] =&gt;</div><div class="line">                        [1] =&gt; D:\xampp\tmp\php65FE.tmp</div><div class="line">                      )</div><div class="line">            [error] =&gt; Array</div><div class="line">                      (</div><div class="line">                        [0] =&gt; 1</div><div class="line">                        [1] =&gt; 0</div><div class="line">                       )</div><div class="line">            [size] =&gt; Array</div><div class="line">                      (</div><div class="line">                         [0] =&gt; 0</div><div class="line">                         [1] =&gt; 50318</div><div class="line">                      )</div><div class="line">            )</div><div class="line">)</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/12/如何调试多文件上传/" data-id="cj0vb5b2r001svqjhn074okwp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/skill/">skill</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android WebView以post方式加载url" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/24/Android WebView以post方式加载url/" class="article-date">
  <time datetime="2016-12-24T14:07:39.000Z" itemprop="datePublished">2016-12-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/24/Android WebView以post方式加载url/">Android WebView以POST方式加载URL</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一般情况下，调用WebView.loadUrl(url)方法即可加载需要展示的Html页面了，如果需要传参数的话，我们也可以把参数拼在url后面(像这样<a href="http://www.baidu.com/s?word=WebView" target="_blank" rel="external">http://www.baidu.com/s?word=WebView</a>)，一并传给服务端。但有时候情况比较特殊，比方说，请求页面的时候我们还想通过post方式传一些参数过去，这个时候直接调用上述方法就不行了。这个时候该怎么办呢？</p>
<p>这里讲一个开发中的小技巧，当你面对一个功能一筹莫展的时候，不妨过一遍相关类的API，看到名字跟你目标有点相关性的就点进去看看，没准有现成的API实现呢！</p>
<p>这里看一下WebView的API：<br><img src="assets/webview_posturl.png"><br>看到了一个方法叫postUrl(url,postData),看方法名跟我们的目标比较接近，再看一参数，url+postData不就是地址+数据吗？看到这里已经七七八八了，应该就是这货。然后我们点进去，看一下方法的介绍。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//android.webkit.WebView.class</span></div><div class="line"><span class="comment">/**</span></div><div class="line">  * Loads the URL with postData using "POST" method into this WebView. If url</div><div class="line">  * 通过POST方法加载URL，并携带postData</div><div class="line">  * is not a network URL, it will be loaded with &#123;<span class="doctag">@link</span> #loadUrl(String)&#125;</div><div class="line">  * instead, ignoring the postData param.</div><div class="line">  *</div><div class="line">  * <span class="doctag">@param</span> url the URL of the resource to load</div><div class="line">  * <span class="doctag">@param</span> postData the data will be passed to "POST" request, which must be</div><div class="line">  * "application/x-www-form-urlencoded" encoded.</div><div class="line">  * 通过POST传递的数据必须先使用"application/x-www-form-urlencoded"编码</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postUrl</span><span class="params">(String url, <span class="keyword">byte</span>[] postData)</span> </span>&#123;</div><div class="line">     checkThread();</div><div class="line">     <span class="keyword">if</span> (URLUtil.isNetworkUrl(url)) &#123;</div><div class="line">         mProvider.postUrl(url, postData);</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         mProvider.loadUrl(url);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>看到这里就可以确认，确实是这货。下面我们就看一下怎么使用这个方法。</p>
<p>第一个参数URL没有问题，就是我们要请求的地址；第二个参数postData是要传递的数据，有点麻烦。方法注释（少年一定要好好看注释呀）里面给了我们提示：传递的数据必须先使用”application/x-www-form-urlencoded”编码。然后我们就看看application/x-www-form-urlencoded编码应该长成什么样子。</p>
<p>编码前数据是这个样子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nickName=Micheal Jack&amp;name=张全蛋</div></pre></td></tr></table></figure></p>
<p>编码后数据变成了酱紫：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nickName=Micheal+Jack&amp;name=%E5%BC%A0%E5%85%A8%E8%9B%8B</div></pre></td></tr></table></figure></p>
<p>你一定在吐槽了：who care！快把你的代码交出来，你就可以去领盒饭了！</p>
<p>ok，下面就献上我的代码，大家慢用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by travis on 2017/3/9.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        user.name = <span class="string">"张全蛋"</span>;</div><div class="line">        user.nickName=<span class="string">"Micheal Jack"</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.print(concatParams(getAllFields(user)));</div><div class="line">        &#125;<span class="keyword">catch</span> (UnsupportedEncodingException e)&#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Map&lt;String,String&gt; <span class="title">getAllFields</span><span class="params">(T t)</span></span>&#123;</div><div class="line">        Field[] field = t.getClass().getDeclaredFields();</div><div class="line">        Map&lt;String,String&gt; fieldsAndValues = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; field.length; i++) &#123;</div><div class="line">                String name = field[i].getName();</div><div class="line">                <span class="keyword">if</span>(field[i].getGenericType().toString().equals(<span class="string">"class java.lang.String"</span>))&#123;</div><div class="line">                    String value = (String) field[i].get(t);</div><div class="line">                    fieldsAndValues.put(name,value);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        System.out.print(<span class="string">""</span>+fieldsAndValues.size());</div><div class="line">        <span class="keyword">return</span> fieldsAndValues;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">concatParams</span><span class="params">(Map&lt;String,String&gt; params)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</div><div class="line">        <span class="keyword">if</span>(params.size() ==<span class="number">0</span>)&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</div><div class="line">        Set&lt;String&gt; keys = params.keySet();</div><div class="line">        Iterator&lt;String&gt; iterator = keys.iterator();</div><div class="line">        <span class="keyword">while</span> (iterator.hasNext())&#123;</div><div class="line">            String key = iterator.next();</div><div class="line">            String value = URLEncoder.encode(params.get(key), <span class="string">"UTF-8"</span>);</div><div class="line">            builder.append(String.format(<span class="string">"%s=%s&amp;"</span>,key, value));</div><div class="line">        &#125;</div><div class="line">        builder.deleteCharAt(builder.lastIndexOf(<span class="string">"&amp;"</span>));</div><div class="line">        <span class="keyword">return</span> builder.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</div><div class="line">        String name;</div><div class="line">        String nickName;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这么简单的东西也被我写了这么长，我真是越来越厉害了！(•̀ᴗ•́)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/24/Android WebView以post方式加载url/" data-id="cj0vb5b0w0001vqjhqfq4jkhd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-system/">Android system</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android图文混排" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/21/android图文混排/" class="article-date">
  <time datetime="2016-12-21T12:55:43.000Z" itemprop="datePublished">2016-12-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/21/android图文混排/">Android图文混排</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>图文混排</code>顾名思义就是把文字和图片混合排列在一起，比较简单的需求我们也可以通过TextView和ImageView配合使用来达到目的，但是遇到稍微复杂一些的情况这种方法就不适用了。</p>
<p>做这样一个按钮：<br><img src="../assets/mix_1.png"></p>
<p>对于你来说没有任何难度：LinearLayout＋TextView＋ImageView搞定；或者可以直接使用TextView的drawableLeft属性。</p>
<p>这里记录两种复杂情况的处理方法：</p>
<ol>
<li>为<code>部分文字</code>添加点击事件；</li>
<li>图文混排,图片居中，图片可点击。</li>
</ol>
<h2 id="1-为部分文字添加点击事件"><a href="#1-为部分文字添加点击事件" class="headerlink" title="1. 为部分文字添加点击事件"></a>1. 为部分文字添加点击事件</h2><p>我最终实现的效果是这个样子的：</p>
<p><img src="../assets/mix_2.png" width="360/"></p>
<p>可点击文字显示为特殊颜色，并可以点击。个人觉得这个最大的特色就是可以像普通文本一样换行，这是组合控件所不能实现的。</p>
<p>这里使用了SpannableString和ClickableSpan实现，具体代码如下：</p>
<p>ClickSpan继承自ClickableSpan：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.text.TextPaint;</div><div class="line"><span class="keyword">import</span> android.text.style.ClickableSpan;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.travis.uqmei.utils.ToastUtil;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by travis on 16/9/18.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClickSpan</span> <span class="keyword">extends</span> <span class="title">ClickableSpan</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String txt;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClickSpan</span><span class="params">(String txt)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.txt = txt;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View widget)</span> </span>&#123;</div><div class="line">        String content = String.format(<span class="string">"ClickSpan is clicked, and txt is %s "</span>,txt);</div><div class="line">        ToastUtil.show(content);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateDrawState</span><span class="params">(TextPaint ds)</span> </span>&#123;</div><div class="line">        <span class="comment">//根据自己的需求定制文本的样式</span></div><div class="line">        ds.setColor(ds.linkColor);</div><div class="line">        ds.setUnderlineText(<span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为TextView设置部分文字可点击效果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">TextView tv = (TextView) findViewById(R.id.tv);</div><div class="line"></div><div class="line">String from = <span class="string">"张全蛋"</span>;</div><div class="line">String to = <span class="string">"赵铁柱"</span>;</div><div class="line">String txt = String.format(<span class="string">"%s回复@%s:我是富士康3号流水线的张全蛋，"</span> +</div><div class="line">      <span class="string">"英文名叫Micheal Jack，发文名叫helodie Jaqueline。"</span>, from, to);</div><div class="line"></div><div class="line">SpannableString span = <span class="keyword">new</span> SpannableString(txt);</div><div class="line">ClickSpan clickSpan = <span class="keyword">new</span> ClickSpan(to);</div><div class="line">span.setSpan(clickSpan, txt.indexOf(to),</div><div class="line">        txt.indexOf(to) + to.length(),</div><div class="line">        Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</div><div class="line">tv.setText(span);</div><div class="line">tv.setMovementMethod(LinkMovementMethod</div><div class="line">        .getInstance());</div></pre></td></tr></table></figure></p>
<h2 id="2-图文混排，图片居中，图片可点击"><a href="#2-图文混排，图片居中，图片可点击" class="headerlink" title="2. 图文混排，图片居中，图片可点击"></a>2. 图文混排，图片居中，图片可点击</h2><p>效果如下：</p>
<p><img src="../assets/mix_3.png" width="360/"></p>
<p>可点击效果通过上述ClickSpan实现，图文混排通过VerticalImageSapn实现。</p>
<p>VerticalImageSpan继承自ImageSpan：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.graphics.Canvas;</div><div class="line"><span class="keyword">import</span> android.graphics.Paint;</div><div class="line"><span class="keyword">import</span> android.graphics.Rect;</div><div class="line"><span class="keyword">import</span> android.graphics.drawable.Drawable;</div><div class="line"><span class="keyword">import</span> android.text.style.ImageSpan;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">     * 垂直居中的ImageSpan</div><div class="line">     *</div><div class="line">     * <span class="doctag">@author</span> travis</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VerticalImageSpan</span> <span class="keyword">extends</span> <span class="title">ImageSpan</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VerticalImageSpan</span><span class="params">(Drawable drawable)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(drawable);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">(Paint paint, CharSequence text, <span class="keyword">int</span> start, <span class="keyword">int</span> end,</span></span></div><div class="line">                           Paint.FontMetricsInt fontMetricsInt) &#123;</div><div class="line">            Drawable drawable = getDrawable();</div><div class="line">            Rect rect = drawable.getBounds();</div><div class="line">            <span class="keyword">if</span> (fontMetricsInt != <span class="keyword">null</span>) &#123;</div><div class="line">                Paint.FontMetricsInt fmPaint = paint.getFontMetricsInt();</div><div class="line">                <span class="keyword">int</span> fontHeight = fmPaint.bottom - fmPaint.top;</div><div class="line">                <span class="keyword">int</span> drHeight = rect.bottom - rect.top;</div><div class="line"></div><div class="line">                <span class="keyword">int</span> top = drHeight / <span class="number">2</span> - fontHeight / <span class="number">4</span>;</div><div class="line">                <span class="keyword">int</span> bottom = drHeight / <span class="number">2</span> + fontHeight / <span class="number">4</span>;</div><div class="line"></div><div class="line">                fontMetricsInt.ascent = -bottom;</div><div class="line">                fontMetricsInt.top = -bottom;</div><div class="line">                fontMetricsInt.bottom = top;</div><div class="line">                fontMetricsInt.descent = top;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> rect.right;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas, CharSequence text, <span class="keyword">int</span> start, <span class="keyword">int</span> end,</span></span></div><div class="line">                         <span class="keyword">float</span> x, <span class="keyword">int</span> top, <span class="keyword">int</span> y, <span class="keyword">int</span> bottom, Paint paint) &#123;</div><div class="line">            Drawable drawable = getDrawable();</div><div class="line">            canvas.save();</div><div class="line">            <span class="keyword">int</span> transY = <span class="number">0</span>;</div><div class="line">            transY = ((bottom - top) - drawable.getBounds().bottom) / <span class="number">2</span> + top;</div><div class="line">            canvas.translate(x, transY);</div><div class="line">            drawable.draw(canvas);</div><div class="line">            canvas.restore();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>代码设置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">TextView tv = (TextView) findViewById(R.id.tv);</div><div class="line"></div><div class="line">        String icon = <span class="string">"icon"</span>;</div><div class="line">        String from = <span class="string">"张全蛋"</span>+icon;</div><div class="line">        String to = <span class="string">"赵铁柱"</span>;</div><div class="line">        String txt = String.format(<span class="string">"%s回复@%s:我是富士康3号流水线的张全蛋，"</span> +</div><div class="line">                <span class="string">"英文名叫Micheal Jack，发文名叫helodie Jaqueline。"</span>, from, to);</div><div class="line"></div><div class="line">        <span class="comment">//设置ClickSpan,为部分文字("icon")添加点击效果</span></div><div class="line">        SpannableString span = <span class="keyword">new</span> SpannableString(txt);</div><div class="line">        ClickSpan clickSpan = <span class="keyword">new</span> ClickSpan(icon);</div><div class="line">        span.setSpan(clickSpan, txt.indexOf(icon),</div><div class="line">                txt.indexOf(icon) + icon.length(),</div><div class="line">                Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</div><div class="line"></div><div class="line">        <span class="comment">//设置ImageSpan,占用可点击文字("icon")的位置</span></div><div class="line">        Bitmap bitmap = ImageUtils.resize(BitmapFactory.decodeResource(getResources(),</div><div class="line">                R.mipmap.uqmei_icon_contact), DensityUtil.sp2px(<span class="keyword">this</span>, <span class="number">12f</span>));</div><div class="line">        BitmapDrawable drawable = <span class="keyword">new</span> BitmapDrawable(bitmap);</div><div class="line">        drawable.setBounds(<span class="number">0</span>, <span class="number">0</span>, bitmap.getWidth(), bitmap.getHeight());</div><div class="line">        span.setSpan(<span class="keyword">new</span> VerticalImageSpan(drawable),</div><div class="line">                txt.indexOf(icon), txt.indexOf(icon) + icon.length(),</div><div class="line">                Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);</div><div class="line"></div><div class="line">        <span class="comment">//设置TextView</span></div><div class="line">        tv.setText(span);</div><div class="line">        tv.setHighlightColor(Color.TRANSPARENT);<span class="comment">//消除点击时的背景色</span></div><div class="line">        tv.setMovementMethod(LinkMovementMethod.getInstance());</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/21/android图文混排/" data-id="cj0vb5b2h001hvqjhf3e1gjdr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/UI/">UI</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Java动态代理Proxy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/13/Java动态代理Proxy/" class="article-date">
  <time datetime="2016-12-13T14:18:03.000Z" itemprop="datePublished">2016-12-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/13/Java动态代理Proxy/">Java动态代理Proxy</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上网查一下Java Proxy几乎都是一样的东西：</p>
<ol>
<li>实体类实现接口；</li>
<li>根据接口生成代理类；</li>
<li>代理类再调用实体类。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyDemo</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IProducer</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteProducer</span> <span class="keyword">implements</span> <span class="title">IProducer</span></span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"producing happiness"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> InvocationHandler handler;</div><div class="line">    <span class="keyword">private</span> ConcreteProducer producer;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyDemo</span><span class="params">()</span></span>&#123;</div><div class="line">        producer = <span class="keyword">new</span> ConcreteProducer();</div><div class="line">        handler = <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                <span class="comment">//我们来做一些羞羞的事情吧。。。</span></div><div class="line">                <span class="keyword">return</span> method.invoke(producer,args);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>&#123;</div><div class="line">        IProducer producer = (IProducer) Proxy.newProxyInstance(IProducer.class.getClassLoader(),<span class="keyword">new</span> Class[]&#123;IProducer.class&#125;,handler);</div><div class="line">        producer.produce();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> ProxyDemo().execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>But，why？为什么要这样处理？套路一定是这样的吗？</p>
<h2 id="为什么要这样处理？"><a href="#为什么要这样处理？" class="headerlink" title="为什么要这样处理？"></a>为什么要这样处理？</h2><p>Proxy对实体类的调用进行了封装，这样我们就可以在真正调用实体类之前做一些羞羞的事情。比方说安全代理，用来控制真实对象的访问权限；智能引用，调用真实对象之前做另外一些事情。</p>
<p>代理模式其实就是在访问对象时引入一定程度的间接性，因为这种间接性，可以附加多种用途。</p>
<h2 id="套路一定是这样的吗？"><a href="#套路一定是这样的吗？" class="headerlink" title="套路一定是这样的吗？"></a>套路一定是这样的吗？</h2><p>并不是！</p>
<p>透过上面的样例我们可以看到:InvocationHandler的invoke方法对修改是开放的，也就是说<font color="#ff3131">invoke方法并不是一定要调用ConcreteProducer的方法</font>！</p>
<p>可能你还有点懵，没有想到一个合适的应用场景，那么我给你一点提示：反射。对，就是反射，Java Proxy + 反射，我们没必要实现一个实体类，也不必实现接口，就可以完成我们想做的事情了。我们对上面的代码做些修改：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyDemo</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IProducer</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">produce</span><span class="params">(String arg1)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">produce</span><span class="params">(String arg1，String arg2)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> InvocationHandler handler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyDemo</span><span class="params">()</span></span>&#123;</div><div class="line">        handler = <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                StringBuilder builder = <span class="keyword">new</span> StringBuilder();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">0</span>;i &lt; args.length;i++)&#123;</div><div class="line">                    builder.append((String)args[i]);</div><div class="line">                    builder.append(<span class="string">","</span>);</div><div class="line">                &#125;</div><div class="line">                builder.append(<span class="string">"来呀，快活呀！"</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>&#123;</div><div class="line">        IProducer producer = (IProducer) Proxy.newProxyInstance(IProducer.class.getClassLoader(),<span class="keyword">new</span> Class[]&#123;IProducer.class&#125;,handler);</div><div class="line">        producer.produce(<span class="string">"二狗"</span>);</div><div class="line">        producer.produce(<span class="string">"二狗"</span>,<span class="string">"全蛋"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> ProxyDemo().execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面代码有些拙劣，不过确实是一个思路。增加了程序的反射能够很好的实现解耦，Proxy又能提供一个切面，还是可以做挺多事情的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/13/Java动态代理Proxy/" data-id="cj0vb5b20000zvqjhq1zr75ch" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android在启动页预加载" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/05/Android在启动页预加载/" class="article-date">
  <time datetime="2016-11-05T13:56:52.000Z" itemprop="datePublished">2016-11-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/05/Android在启动页预加载/">Android在启动页预加载</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="项目需求：展示欢迎页的同时执行token登录和首页预加载"><a href="#项目需求：展示欢迎页的同时执行token登录和首页预加载" class="headerlink" title="项目需求：展示欢迎页的同时执行token登录和首页预加载"></a>项目需求：展示欢迎页的同时执行token登录和首页预加载</h2><h2 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h2><p>在此之前，展示欢迎页和token登录等网络操作是串行的，所以用户点开App到最终看到首页的时间就是：”展示欢迎页的时间”+”登录时间”+”请求首页数据时间”。单线程处理这些事情的优点是逻辑清晰，控制简单。缺点也非常突出：用户的体验并不好，特别是网络状况不佳的时候，等待时间大幅增加。</p>
<p>这个版本我们加入了跳过功能，对于等待时间的要求更高了，我不得不“磨刀霍霍”着手解决这个问题。</p>
<h2 id="场景："><a href="#场景：" class="headerlink" title="场景："></a>场景：</h2><ol>
<li>欢迎页可能执行的网络操作：检查版本更新、token登录、预加载首页数据（两个接口）；</li>
<li>如果本地保存有用户的登录信息，执行token登录；</li>
<li>如果本地未保存用户的登录信息，跳转到登录页；</li>
<li>如果出现网络连接错误（断网、超时等），直接提示用户”网络错误”，退出软件；</li>
<li>如果需要强制更新，跳转到登录页进行更新；</li>
<li>token登录失败，跳转到登录页；</li>
<li>全部接口请求完成（仅指token登录成功），携带数据启动首页。</li>
</ol>
<h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><ol>
<li>展示欢迎页的同时启动所有网络请求；</li>
<li>使用AtomicInteger计数，使用AtomicBoolean标记关键事件（是否达到展示时间、是否发生网络错误、是否需要跳转到登录页）；</li>
<li>每个网络操作完成时要及时更新计数器，如果发生“关心”事件要进行登记；</li>
<li>每个网络操作完成时都要进行终点测试（判断自己是否是最后完成者，是的话就要执行跳转）。</li>
</ol>
<h2 id="关键代码："><a href="#关键代码：" class="headerlink" title="关键代码："></a>关键代码：</h2><h3 id="网络请求样例："><a href="#网络请求样例：" class="headerlink" title="网络请求样例："></a>网络请求样例：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">VersionModelImpl.CheckVersionListener listener = <span class="keyword">new</span> VersionModelImpl.CheckVersionListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(JSONObject data)</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">final</span> Version version = <span class="keyword">new</span> Gson().fromJson(data.toString(), Version.class);</div><div class="line">                    <span class="keyword">if</span> (isMustUpdate(version)) &#123;</div><div class="line">                        mNeedLogin.set(<span class="keyword">true</span>);<span class="comment">//登记状态</span></div><div class="line">                    &#125;</div><div class="line">                    isCheckVersionSuccess = <span class="keyword">true</span>;<span class="comment">// 记录检查版本的结果</span></div><div class="line">                    mStepsAtomicInteger.getAndIncrement();<span class="comment">// 计数</span></div><div class="line">                    finalTest();<span class="comment">//终点测试</span></div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                    mNeedLogin.set(<span class="keyword">true</span>);</div><div class="line">                    mStepsAtomicInteger.getAndIncrement();</div><div class="line">                    finalTest();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(String code, String message)</span> </span>&#123;</div><div class="line">                mIsNetworkError.set(<span class="keyword">true</span>);<span class="comment">// 登记网络错误</span></div><div class="line">                mStepsAtomicInteger.getAndIncrement();</div><div class="line">                finalTest();</div><div class="line">            &#125;</div><div class="line">        &#125;;</div></pre></td></tr></table></figure>
<h3 id="终点测试方法："><a href="#终点测试方法：" class="headerlink" title="终点测试方法："></a>终点测试方法：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//终点测试，判断预加载是否都完成</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">finalTest</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!mAllowFinalTestAtomicBoolean.get()) &#123;<span class="comment">//时间是否满足</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(mIsNetworkError.get())&#123;<span class="comment">//如果网络错误</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">final</span> Dialog dialog = confirm(<span class="string">"网络信号不好哟~宝宝卡得要哭了~"</span>);</div><div class="line">                dialog.setOnDismissListener(<span class="keyword">new</span> DialogInterface.OnDismissListener() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDismiss</span><span class="params">(DialogInterface dialog)</span> </span>&#123;</div><div class="line">                        onBackPressed();</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mNeedLogin.get()) &#123;<span class="comment">//如果需要登录</span></div><div class="line">            LoginActivity.enterLogin(PictureActivity.<span class="keyword">this</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mStepsAtomicInteger.intValue() &gt;= <span class="number">4</span>) &#123;<span class="comment">//所有网络请求都已返回</span></div><div class="line">            <span class="keyword">if</span> (isCheckVersionSuccess &amp;&amp; isLoginByTokenSuccess) &#123;</div><div class="line">                enterMainActivity();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                LoginActivity.enterLogin(PictureActivity.<span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/11/05/Android在启动页预加载/" data-id="cj0vb5b1o000nvqjh433vmyau" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-system/">Android system</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-这个字段到底有没有返回" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/03/这个字段到底有没有返回/" class="article-date">
  <time datetime="2016-11-03T12:13:45.000Z" itemprop="datePublished">2016-11-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/03/这个字段到底有没有返回/">这个字段到底有没有返回</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>开发过程中总是会遇到诸如题目中的问题，前后端各执一词，有时不惜为此争得脸红脖子粗。这里记录一下，工作中我是怎么处理这些问题的，大家慎重参考，学艺不精被打脸，跟本人无关。</p>
<p>这篇文章主要讲这么几个方面：1.服务端到底有没有返回某个字段？2.客户端到底有没有传某个字段到服务端？3.服务端要求传数组，可是Http请求里面的数组是个什么鬼？各位乘客请系好安全带，马上就要发车了！</p>
<h2 id="1-服务端到底有没有返回某个字段？"><a href="#1-服务端到底有没有返回某个字段？" class="headerlink" title="1. 服务端到底有没有返回某个字段？"></a>1. 服务端到底有没有返回某个字段？</h2><p>核心思想就一句话：<code>重新请求，重新返回</code>。</p>
<p>我好想听见有人说:”我裤子都脱了，你给我看这个?”。这位乘客别生气，且容我慢慢道来。你可以在Android Monitor里面把返回的数据输出一下，然后把CTRL+C/V转发给服务端的同学。But！服务端的同学就开始跟你怼：”我返回的数据没有问题呀”；”你本地是不是加了缓存”；”你调错接口了吧”…Shut Up！即使你把他说服了，你还得配合他联调，绳命是剁么的回晃，绳命是入刺的井猜，哪能浪费在这些事情上。</p>
<p>我们的目标是重新构造一个请求，然后重放一下。为了构造这个请求，我们在原来网络请求框架上处理流程中添加一个方法，用以打印请求URL和请求参数。如果请求方式是GET，不妨直接把URL和参数拼接好，然后再打印。如果是post请求，相对麻烦一些，写一个html文件，用打印出来的URL和请求参数构建一个form表单，通过form表单，在浏览器中请求。</p>
<p>OK，现在你手里面有一个完整的URL或表单请求，如果后端同学不肯弯腰捡肥皂，你就可以把东西丢给他让他自己反省。</p>
<p>下面贴一下我用的表单：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">'utf-8'</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>打脸神器<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></div><div class="line">    input&#123;</div><div class="line">      margin: 8px auto 8px 8px;</div><div class="line">    &#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://www.baidu.com/s"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>word<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"word"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="2-客户端到底有没有传某个字段到服务端？"><a href="#2-客户端到底有没有传某个字段到服务端？" class="headerlink" title="2. 客户端到底有没有传某个字段到服务端？"></a>2. 客户端到底有没有传某个字段到服务端？</h2><p>有的时候自己都不确定调用接口的时候有没有把要求的字段传过去，这个时候完全看服务端大爷的脸色吗？怎么可能？他们还没那么拽(不过话又说回来，当你没有更好的办法的时候还是态度好一点，跟人家好好配合)。方法也就一句话:”在服务端检查一下客户端的传参”。快下班了，就不瞎扯别的了，赶紧写完收工。</p>
<p>直接讲我的做法，我在自己电脑上搭了一个PHP环境(PHP简单好用，你值得拥有)，然后把请求的URL重定向到本地的PHP页面。比如我的电脑局域网ip是 192.168.1.66，PHP服务器运行在80端口，PHP页面是index.php,客户端别的都不用变，只用把请求URL改成<a href="http://192.168.1.66:80/demo/index.php" target="_blank" rel="external">http://192.168.1.66:80/demo/index.php</a> 就可以在PHP服务器上接收到请求了。检验字段什么的，都不在话下。</p>
<p>这句神奇的PHP代码就是<code>echo $_REQUEST[&#39;参数名称&#39;]</code>。</p>
<h2 id="3-服务端要求传数组，可是Http请求里面的数组是个什么鬼？"><a href="#3-服务端要求传数组，可是Http请求里面的数组是个什么鬼？" class="headerlink" title="3. 服务端要求传数组，可是Http请求里面的数组是个什么鬼？"></a>3. 服务端要求传数组，可是Http请求里面的数组是个什么鬼？</h2><p>这个内容其实可以算是<code>2</code>的一个引申。服务端说让客户端传数组，前端同学一脸的懵比，What 数组？？？懵归懵，我还是有一点思路的。像<code>2</code>一样，我把请求重新定向到本地PHP页面，然后不断的改客户端代码，根据PHP的接收情况，不断尝试终于被我发现了真相！其实所谓的数组是一伪名词，客户端传过去的数据是这个样子的：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">array[0]=value0&amp;array[1]=value1</div></pre></td></tr></table></figure></p>
<p>看完之后你可能也有点懵，直接上代码看看我是怎么处理的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Map&lt;String,String&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">String array[] = <span class="keyword">new</span> String[]&#123;<span class="string">"value0"</span>,<span class="string">"value1"</span>&#125;;</div><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i =<span class="number">0</span>;i&lt;array.length;i++)&#123;</div><div class="line">    params.put(String.format(<span class="string">"array[%d]"</span>,i),array[i]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样一来，服务端就能按照解析数组来解析客户端的请求参数了。<br>上面介绍的方法并不局限于上面所提到的问题，开发过程中遇到的很多问题都可以用上面的方法来解决。<br>突然想到，如果使用fiddler抓包工具。。。难道我是拿着lowB技术在开车?不行，我得去研究一下！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/11/03/这个字段到底有没有返回/" data-id="cj0vb5b2z001zvqjhywzb4vos" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/skill/">skill</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-system/">Android system</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Json/">Json</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UI/">UI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gradle/">gradle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/skill/">skill</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlite/">sqlite</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android-system/" style="font-size: 17.5px;">Android system</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Json/" style="font-size: 12.5px;">Json</a> <a href="/tags/UI/" style="font-size: 20px;">UI</a> <a href="/tags/gradle/" style="font-size: 12.5px;">gradle</a> <a href="/tags/skill/" style="font-size: 12.5px;">skill</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/03/27/Retrofit详解/">Retrofit详解</a>
          </li>
        
          <li>
            <a href="/2017/03/14/Retrofit中的Json解析/">Retrofit中的Json解析</a>
          </li>
        
          <li>
            <a href="/2017/02/20/Android应用内开新进程的一些行为记录/">Android应用内开新进程的一些行为记录</a>
          </li>
        
          <li>
            <a href="/2017/02/13/ViewPager+Fragments+LazyLoad/">ViewPager+Fragments+LazyLoad</a>
          </li>
        
          <li>
            <a href="/2017/01/25/后台应用被系统回收后重启/">后台应用被系统回收后重启</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Travis<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>