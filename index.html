<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Travis&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Travis's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Travis's Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Travis's Blog">
  
    <link rel="alternate" href="/atom.xml" title="Travis&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Travis&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Java动态代理Proxy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/28/Java动态代理Proxy/" class="article-date">
  <time datetime="2017-03-27T18:47:00.000Z" itemprop="datePublished">2017-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/28/Java动态代理Proxy/">Java动态代理Proxy</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上网查一下Java Proxy几乎都是一样的东西：</p>
<ol>
<li>实体类实现接口；</li>
<li>根据接口生成代理类；</li>
<li>代理类再调用实体类。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyDemo</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IProducer</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteProducer</span> <span class="keyword">implements</span> <span class="title">IProducer</span></span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"producing happiness"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> InvocationHandler handler;</div><div class="line">    <span class="keyword">private</span> ConcreteProducer producer;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyDemo</span><span class="params">()</span></span>&#123;</div><div class="line">        producer = <span class="keyword">new</span> ConcreteProducer();</div><div class="line">        handler = <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                <span class="comment">//我们来做一些羞羞的事情吧。。。</span></div><div class="line">                <span class="keyword">return</span> method.invoke(producer,args);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>&#123;</div><div class="line">        IProducer producer = (IProducer) Proxy.newProxyInstance(IProducer.class.getClassLoader(),<span class="keyword">new</span> Class[]&#123;IProducer.class&#125;,handler);</div><div class="line">        producer.produce();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> ProxyDemo().execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>But，why？为什么要这样处理？套路一定是这样的吗？</p>
<h2 id="为什么要这样处理？"><a href="#为什么要这样处理？" class="headerlink" title="为什么要这样处理？"></a>为什么要这样处理？</h2><p>Proxy对实体类的调用进行了封装，这样我们就可以在真正调用实体类之前做一些羞羞的事情。比方说安全代理，用来控制真实对象的访问权限；智能引用，调用真实对象之前做另外一些事情。</p>
<p>代理模式其实就是在访问对象时引入一定程度的间接性，因为这种间接性，可以附加多种用途。</p>
<h2 id="套路一定是这样的吗？"><a href="#套路一定是这样的吗？" class="headerlink" title="套路一定是这样的吗？"></a>套路一定是这样的吗？</h2><p>并不是！</p>
<p>透过上面的样例我们可以看到:InvocationHandler的invoke方法对修改是开放的，也就是说<font color="#ff3131">invoke方法并不是一定要调用ConcreteProducer的方法</font>！</p>
<p>可能你还有点懵，没有想到一个合适的应用场景，那么我给你一点提示：反射。对，就是反射，Java Proxy + 反射，我们没必要实现一个实体类，也不必实现接口，就可以完成我们想做的事情了。我们对上面的代码做些修改：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyDemo</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IProducer</span></span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">produce</span><span class="params">(String arg1)</span></span>;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">produce</span><span class="params">(String arg1，String arg2)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> InvocationHandler handler;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyDemo</span><span class="params">()</span></span>&#123;</div><div class="line">        handler = <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                StringBuilder builder = <span class="keyword">new</span> StringBuilder();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">0</span>;i &lt; args.length;i++)&#123;</div><div class="line">                    builder.append((String)args[i]);</div><div class="line">                    builder.append(<span class="string">","</span>);</div><div class="line">                &#125;</div><div class="line">                builder.append(<span class="string">"来呀，快活呀！"</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>&#123;</div><div class="line">        IProducer producer = (IProducer) Proxy.newProxyInstance(IProducer.class.getClassLoader(),<span class="keyword">new</span> Class[]&#123;IProducer.class&#125;,handler);</div><div class="line">        producer.produce(<span class="string">"二狗"</span>);</div><div class="line">        producer.produce(<span class="string">"二狗"</span>,<span class="string">"全蛋"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> ProxyDemo().execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面代码有些拙劣，不过确实是一个思路。增加了程序的反射能够很好的实现解耦，Proxy又能提供一个切面，还是可以做挺多事情的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/28/Java动态代理Proxy/" data-id="cj0uytlfs000bawjhreu2b1cf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-PhotoView使用过程中遇到的坑" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/28/PhotoView使用过程中遇到的坑/" class="article-date">
  <time datetime="2017-03-27T18:47:00.000Z" itemprop="datePublished">2017-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/28/PhotoView使用过程中遇到的坑/">PhotoView使用过程中的坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-1问题：ImageView-no-longer-exists-You-should-not-use-this-PhotoViewAttacher-any-more"><a href="#1-1问题：ImageView-no-longer-exists-You-should-not-use-this-PhotoViewAttacher-any-more" class="headerlink" title="1.1问题：ImageView no longer exists. You should not use this PhotoViewAttacher any more"></a>1.1问题：<code>ImageView no longer exists. You should not use this PhotoViewAttacher any more</code></h2><p>这个问题是因为:removeView(PhotoView)时会调用PhotoView.onDetachedFromWindow()–&gt;PhotoViewAttacher.cleanup()。在cleanup()方法中清空了PhotoViewAttacher持有的PhotoView，而在onAttachToWindow()方法中没有重置。</p>
<h2 id="1-2-解决方法："><a href="#1-2-解决方法：" class="headerlink" title="1.2 解决方法："></a>1.2 解决方法：</h2><p>使用github上面最新版本的<a href="https://github.com/chrisbanes/PhotoView" target="_blank" rel="external">PhotoView</a>,最新版本的PhotoView解决了这个问题。或者复写PhotoView.onAttachToWindow()方法，在该方法内重新生成PhotoViewAttacher实例，具体要结合代码。</p>
<h2 id="2-1-问题：PhotoView-setOnPhotoTapListener-OnPhotoTapListener-不起作用"><a href="#2-1-问题：PhotoView-setOnPhotoTapListener-OnPhotoTapListener-不起作用" class="headerlink" title="2.1 问题：PhotoView.setOnPhotoTapListener(OnPhotoTapListener)不起作用"></a>2.1 问题：PhotoView.setOnPhotoTapListener(OnPhotoTapListener)不起作用</h2><p>原因：PhotoView.setOnPhotoTapListener(OnPhotoTapListener)内部直接调用了PhotoViewAttacher.setOnPhotoTapListener(OnPhotoTapListener),依赖于PhotoView现在持有的PhotoViewAttacher，如果Container.removeView(PhotoView)–&gt;Container.addView(PhotoView),这样操作之后，PhotoView持有的PhotoViewAttacher已经变了，而且没有被设置OnPhotoTapListener，所以单击不起作用。</p>
<h2 id="2-2-解决方法"><a href="#2-2-解决方法" class="headerlink" title="2.2 解决方法"></a>2.2 解决方法</h2><p>修改PhotoView的代码逻辑,在重新创建PhotoViewAttacher的时候为其设置OnPhotoTapListener：</p>
<ol>
<li><p>改写setOnPhotoTapListener(OnPhotoTapListener)方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnPhotoTapListener</span><span class="params">(OnPhotoTapListener listener)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.mOnPhotoTapListener = listener;</div><div class="line">      mAttacher.setOnPhotoTapListener(listener);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>改写init()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == mAttacher || <span class="keyword">null</span> == mAttacher.getImageView()) &#123;</div><div class="line">          mAttacher = <span class="keyword">new</span> PhotoViewAttacher(<span class="keyword">this</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != mPendingScaleType) &#123;</div><div class="line">          setScaleType(mPendingScaleType);</div><div class="line">          mPendingScaleType = <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != mOnPhotoTapListener) &#123;</div><div class="line">          mAttacher.setOnPhotoTapListener(mOnPhotoTapListener);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/28/PhotoView使用过程中遇到的坑/" data-id="cj0uytlg1000fawjh0g96v7rt" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Looper和Handler类" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/Looper和Handler类/" class="article-date">
  <time datetime="2017-03-27T07:46:30.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/Looper和Handler类/">Looper和Handler类</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Handler原理分析"><a href="#Handler原理分析" class="headerlink" title="Handler原理分析"></a>Handler原理分析</h2><font color="#ff3131">本文系邓凡平老师《深入理解Android(卷1)》节选。</font>

<p>了解Looper和Handler可以参考以下文章：<br><br><a href="http://blog.csdn.net/u013435893/article/details/50903082" target="_blank" rel="external">《Android中为什么主线程不会因为Looper.loop()方法造成阻塞》</a></p>
<p>就应用程序而言，Android系统中java的应用程序和其它系统上相同，都是靠消息驱动来工作的，它们大致的工作原理如下：</p>
<ol>
<li>有一个消息队列，可以往这个消息队列中投递消息。</li>
<li>有一个消息循环，不断的从消息队列中取出消息，然后处理。</li>
</ol>
<p>下面的图示即可展示这个工作过程。<br><img src="消息队列示意图.png" width="480/"></p>
<p>从图中可以看出：</p>
<ol>
<li><p>事件源把待处理的消息加入到消息队列中，一般是加至队列尾，一些优先级高的消息也可以加至队列头。事件源提交的消息可以是按键、触摸屏等物理时间产生的消息，也可以是系统或应用程序本身发出的请求消息。</p>
</li>
<li><p>处理线程不断的从消息队列头部取出消息并处理，事件源可以把优先级高的消息放到消息头，这样优先级高的消息就会首先被处理。</p>
</li>
</ol>
<p>在Android系统中，这些工作主要由Looper和Handler来实现：<br>Looper类，用于封装消息循环，并且有一个消息队列。</p>
<p>Handler类，有点像辅助类，它封装了消息投递、消息处理等接口。</p>
<p>Looper类是其中的关键。先来看看它是怎么做的。</p>
<h2 id="Looper类的分析"><a href="#Looper类的分析" class="headerlink" title="Looper类的分析"></a>Looper类的分析</h2><p>我们以Looper使用的一个常见例子来分析这个Looper类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> Handler mHandler;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="comment">// 调用prepare</span></div><div class="line">        Looper.prepare();</div><div class="line">        ...</div><div class="line">        <span class="comment">// 进入消息循环</span></div><div class="line">        Looper.loop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的两处注释就是Looper使用的关键步骤，我们逐一进行分析。</p>
<ol>
<li><p>准备好了吗？</p>
<p>第一个函数是Looper的prepare函数。它会做什么工作呢？<br>代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Looper.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">    <span class="comment">// 一个Looper只能调用一次prepare</span></div><div class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</div><div class="line">    &#125;</div><div class="line">      <span class="comment">//构造一个Looper对象，设置到调用线程的局部变量中</span></div><div class="line">    sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</div><div class="line">&#125;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal sThreadLocal = <span class="keyword">new</span> ThreadLocal();</div></pre></td></tr></table></figure>
<p>ThreadLocal是java中的线程局部变量类，全名应该是ThreadLocalVariable。该类有两个关键函数：</p>
<ul>
<li>set:设置调用县城的局部变量；</li>
<li>get:获取调用线程的局部变量。</li>
</ul>
<p>根据上面的分析可知，prepare会在调用线程的局部变量中设置一个Looper对象。这个调用线程就是LooperThread的run线程。先看看Looper对象的构造，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="comment">//构造一个消息队列</span></div><div class="line">  mQueue = <span class="keyword">new</span> MessageQueue();</div><div class="line">  mRun = <span class="keyword">true</span>;</div><div class="line">  <span class="comment">//得到当前线程的Thread对象</span></div><div class="line">  mThread = Thread.currentThread();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>prepare函数很简单，它主要干了一件事：<br>在调用prepare的线程中，设置了一个Looper对象，这个Looper对象就保存在这个调用线程的ThreadLocalVariable中。而Looper对象内部封装了一个消息队列。</p>
<p>也就是说，prepare函数通过ThreadLocal机制，巧妙地把Looper和调用线程关联在一起了。要了解这样做的目的是什么，需要再看第二个重要函数。</p>
</li>
<li><p>Looper循环<br>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line"> * Run the message queue in this thread. Be sure to call</div><div class="line"> * &#123;<span class="doctag">@link</span> #quit()&#125; to end the loop.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Looper me = myLooper();</div><div class="line">    <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">final</span> MessageQueue queue = me.mQueue;</div><div class="line"></div><div class="line">    <span class="comment">// Make sure the identity of this thread is that of the local process,</span></div><div class="line">    <span class="comment">// and keep track of what that identity token actually is.</span></div><div class="line">    Binder.clearCallingIdentity();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        Message msg = queue.next(); <span class="comment">// might block</span></div><div class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// No message indicates that the message queue is quitting.</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></div><div class="line">        <span class="keyword">final</span> Printer logging = me.mLogging;</div><div class="line">        <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">            logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</div><div class="line">                    msg.callback + <span class="string">": "</span> + msg.what);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> traceTag = me.mTraceTag;</div><div class="line">        <span class="keyword">if</span> (traceTag != <span class="number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</div><div class="line">            Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            msg.target.dispatchMessage(msg);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</div><div class="line">                Trace.traceEnd(traceTag);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">            logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Make sure that during the course of dispatching the</span></div><div class="line">        <span class="comment">// identity of the thread wasn't corrupted.</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</div><div class="line">        <span class="keyword">if</span> (ident != newIdent) &#123;</div><div class="line">            Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></div><div class="line">                    + Long.toHexString(ident) + <span class="string">" to 0x"</span></div><div class="line">                    + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></div><div class="line">                    + msg.target.getClass().getName() + <span class="string">" "</span></div><div class="line">                    + msg.callback + <span class="string">" what="</span> + msg.what);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        msg.recycleUnchecked();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"> * Return the Looper object associated with the current thread.  Returns</div><div class="line"> * null if the calling thread is not associated with a Looper.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> sThreadLocal.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上面的分析，Looper的作用是：</p>
<ul>
<li>封装了一个消息队列。</li>
<li>Looper的prepare函数把这个Looper和调用prepare的线程(也就是最终的处理线程)绑定在一起了。</li>
<li>处理线程调用loop函数，处理来自该消息队列的消息。</li>
</ul>
<p>当事件源向这个Looper发送消息的时候，其实是把消息加到这个Looper的消息队列里了。那么，该消息就将有和Looper绑定的线程来处理。可事件源又是怎么向Looper消息队列中添加消息的呢？来看下一节。</p>
</li>
<li><p>Looper、Message和Handler的关系<br>Looper、Message、Handler三者之间的关系用两句话就能够说清楚：</p>
<ul>
<li>Looper中有一个Message消息队列，里面存储的是一个个待处理的Mesage。</li>
<li>Message中有一个Handler，这个Handler是用来处理Message的。</li>
</ul>
<p>其中Handler类封装了很多琐碎的工作。</p>
</li>
</ol>
<h2 id="Looper和Handler的同步关系"><a href="#Looper和Handler的同步关系" class="headerlink" title="Looper和Handler的同步关系"></a>Looper和Handler的同步关系</h2><p>Looper和Handler会有什么同步关系呢？它们之间确实存在同步关系，而且如果不注意此同步关系，定会铸成大错。</p>
<p>同步关系肯定与多线程有关系，我们来看下面一个例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//先定义一个LooperThread类</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">  <span class="comment">//定义一个public的成员myLooper，初值为空</span></div><div class="line">  <span class="keyword">public</span> Looper myLooper = <span class="keyword">null</span>;;</div><div class="line">  <span class="comment">//假设run在线程2中执行</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="comment">//myLooper必须在这个线程中赋值</span></div><div class="line">    myLooper = Looper.myLooper();</div><div class="line">    Looper.loop();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//下面这段代码在线程1中执行，并且会创建线程2</span></div><div class="line">LooperThread lpThred = <span class="keyword">new</span> LooperThread();</div><div class="line"><span class="comment">//start后会创建线程2</span></div><div class="line">lpThread.start();</div><div class="line"><span class="comment">//warn</span></div><div class="line">Looper looper = lpThread.myLooper;</div><div class="line"><span class="comment">//thread2Handler和线程2的Looper绑定</span></div><div class="line">Handler thread2Handler = <span class="keyword">new</span> Handler(looper);</div><div class="line"><span class="comment">//sendMessage发送的消息将有线程2处理</span></div><div class="line">thread2Handler.sendMessage();</div></pre></td></tr></table></figure></p>
<p>上面这段代码的目的非常简单：</p>
<ul>
<li>线程1中创建线程2，并且线程2通过Looper处理消息。</li>
<li>线程1中得到的线程2的Looper，并且根据这个Looper创建一个Handler，这样发送给该Handler的消息将由线程2处理。</li>
</ul>
<p>很可惜，上面的代码是有问题的。如果我们熟悉多线程，就会发现“warn”的那行代码存在严重的问题。myLooper的创建实在线程2中，而不是在线程1中，很有可能此时线程2的run函数还没来得及给myLooper赋值，这样线程1中的looper将取到myLooper的初值，也就是looper等于null。</p>
<p>对于这个问题，可以采用同步的方式完成处理。你是不是有点迫不及待地想完善这个例子了？其实Android早就替我们想好了，它提供了一个HandlerThread来解决这个问题。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HandlerThread.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    mTid = Process.myTid();</div><div class="line">    Looper.prepare();</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        mLooper = Looper.myLooper();</div><div class="line">        notifyAll();</div><div class="line">    &#125;</div><div class="line">    Process.setThreadPriority(mPriority);</div><div class="line">    onLooperPrepared();</div><div class="line">    Looper.loop();</div><div class="line">    mTid = -<span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * This method returns the Looper associated with this thread. If this thread not been started</div><div class="line"> * or for any reason is isAlive() returns false, this method will return null. If this thread</div><div class="line"> * has been started, this method will block until the looper has been initialized.  </div><div class="line"> * <span class="doctag">@return</span> The looper.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Looper <span class="title">getLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!isAlive()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If the thread has been started, wait until the looper has been created.</span></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">while</span> (isAlive() &amp;&amp; mLooper == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                wait();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> mLooper;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/Looper和Handler类/" data-id="cj0uytlfz000eawjhpzbo4ymy" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Android布局文件中的onClick属性" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/Android布局文件中的onClick属性/" class="article-date">
  <time datetime="2017-03-27T07:46:30.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/Android布局文件中的onClick属性/">Android布局文件中的onClick属性</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在写布局文件的时候可能会遇到onClick属性，这个属性使干啥的呢？也许你知道，这是为View注册了一个onClick事件，但是这背后的原理又是什么呢？这篇文章或许能够解答你的疑惑。</p>
<p>先来看一下代码,首先是布局文件：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--activity_main.xml--&gt;</span></div><div class="line"></div><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"center_horizontal"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"40dp"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"MainActivity"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"160dp"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"40dp"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"Start_Second_Activity"</span></div><div class="line">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"center_horizontal"</span></div><div class="line">        <span class="attr">android:layout_marginTop</span>=<span class="string">"40dp"</span></div><div class="line">        <span class="attr">android:clickable</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:onClick</span>=<span class="string">"startSecondActivity"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"?attr/selectableItemBackgroundBorderless"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>然后是java代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startSecondActivity</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>,SecondActivity.class);</div><div class="line">        startActivity(intent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过以上简单的设置，我们就为View注册了一个点击时间，点击之后启动SecondActivity。</p>
<p>但是这背后的原理又是什么呢？我们不妨查看一下View的源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> R.styleable.View_onClick:</div><div class="line">    <span class="keyword">if</span> (context.isRestricted()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The android:onClick attribute cannot "</span></div><div class="line">                + <span class="string">"be used within a restricted context"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> String handlerName = a.getString(attr);</div><div class="line">    <span class="keyword">if</span> (handlerName != <span class="keyword">null</span>) &#123;</div><div class="line">        setOnClickListener(<span class="keyword">new</span> DeclaredOnClickListener(<span class="keyword">this</span>, handlerName));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">break</span>;</div></pre></td></tr></table></figure></p>
<p>我们可以看到，onClick属性被当作字符串解析了，并且为View注册了点击事件。看到这里我们大概能够想到，应该是在这个点击事件中，点击时间被重定向到了MainActivity中的startSecondActivity。下面我们看下DeclaredOnClickListener的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * An implementation of OnClickListener that attempts to lazily load a</div><div class="line">  * named click handling method from a parent or ancestor context.</div><div class="line">  */</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DeclaredOnClickListener</span> <span class="keyword">implements</span> <span class="title">OnClickListener</span> </span>&#123;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> View mHostView;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> String mMethodName;</div><div class="line"></div><div class="line">     <span class="keyword">private</span> Method mResolvedMethod;</div><div class="line">     <span class="keyword">private</span> Context mResolvedContext;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="title">DeclaredOnClickListener</span><span class="params">(@NonNull View hostView, @NonNull String methodName)</span> </span>&#123;</div><div class="line">         mHostView = hostView;</div><div class="line">         mMethodName = methodName;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="meta">@Override</span></div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(@NonNull View v)</span> </span>&#123;</div><div class="line">         <span class="keyword">if</span> (mResolvedMethod == <span class="keyword">null</span>) &#123;</div><div class="line">             resolveMethod(mHostView.getContext(), mMethodName);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">             mResolvedMethod.invoke(mResolvedContext, v);</div><div class="line">         &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">                     <span class="string">"Could not execute non-public method for android:onClick"</span>, e);</div><div class="line">         &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">                     <span class="string">"Could not execute method for android:onClick"</span>, e);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="meta">@NonNull</span></div><div class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resolveMethod</span><span class="params">(@Nullable Context context, @NonNull String name)</span> </span>&#123;</div><div class="line">         <span class="keyword">while</span> (context != <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">try</span> &#123;</div><div class="line">                 <span class="keyword">if</span> (!context.isRestricted()) &#123;</div><div class="line">                     <span class="keyword">final</span> Method method = context.getClass().getMethod(mMethodName, View.class);</div><div class="line">                     <span class="keyword">if</span> (method != <span class="keyword">null</span>) &#123;</div><div class="line">                         mResolvedMethod = method;</div><div class="line">                         mResolvedContext = context;</div><div class="line">                         <span class="keyword">return</span>;</div><div class="line">                     &#125;</div><div class="line">                 &#125;</div><div class="line">             &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">                 <span class="comment">// Failed to find method, keep searching up the hierarchy.</span></div><div class="line">             &#125;</div><div class="line"></div><div class="line">             <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextWrapper) &#123;</div><div class="line">                 context = ((ContextWrapper) context).getBaseContext();</div><div class="line">             &#125; <span class="keyword">else</span> &#123;</div><div class="line">                 <span class="comment">// Can't search up the hierarchy, null out and fail.</span></div><div class="line">                 context = <span class="keyword">null</span>;</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="keyword">final</span> <span class="keyword">int</span> id = mHostView.getId();</div><div class="line">         <span class="keyword">final</span> String idText = id == NO_ID ? <span class="string">""</span> : <span class="string">" with id '"</span></div><div class="line">                 + mHostView.getContext().getResources().getResourceEntryName(id) + <span class="string">"'"</span>;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Could not find method "</span> + mMethodName</div><div class="line">                 + <span class="string">"(View) in a parent or ancestor Context for android:onClick "</span></div><div class="line">                 + <span class="string">"attribute defined on view "</span> + mHostView.getClass() + idText);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>看到这里就一目了然了，的确是DeclaredOnClickListener重新把OnClick事件定向到了MainActivity当中的startSecondActivity，这里主要使用到了反射，通过解析onClick属性得到的方法名调用了该方法。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/Android布局文件中的onClick属性/" data-id="cj0uytlfa0003awjhjd279du9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Android应用内开新进程的一些行为记录" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/Android应用内开新进程的一些行为记录/" class="article-date">
  <time datetime="2017-03-27T07:46:30.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/Android应用内开新进程的一些行为记录/">Android应用内开新进程的一些行为记录</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><p>直接在Manifest文件当中设置<code>android:process=&quot;:browser&quot;</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span></span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">".activity.BrowserActivity"</span></div><div class="line">    <span class="attr">android:screenOrientation</span>=<span class="string">"portrait"</span></div><div class="line">    <span class="attr">android:process</span>=<span class="string">":browser"</span>&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这样启动BrowserActivity之后，Activity就在一个新的进程当中了。</p>
</li>
<li><p>新进程的Application和原来的Application是什么关系？</p>
<p>新进程Application和原Application是同一个类，但已经是不同的对象了，并且静态成员也不一样了。</p>
</li>
<li><p>在新进程里面启动一个不带<code>process</code>属性的Activity，Activity运行在哪个进程中？</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="tag">&lt;<span class="name">activity</span></span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">".test.TestActivity"</span></div><div class="line">    <span class="attr">android:screenOrientation</span>=<span class="string">"portrait"</span>&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div></pre></td></tr></table></figure>
<p>测试发现：TestActivity运行在原进程当中</p>
</li>
<li><p>原进程退出之后，新进程能否继续运行？</p>
<p>是！</p>
<p>但是如果用户调用最近任务栏，清空最近任务，新进程也会被杀死！</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/Android应用内开新进程的一些行为记录/" data-id="cj0uytlfb0004awjhxaqw70ed" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Android应用内部数据同步" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/Android应用内部数据同步/" class="article-date">
  <time datetime="2017-03-27T07:46:30.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/Android应用内部数据同步/">Android应用内数据同步</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="场景："><a href="#场景：" class="headerlink" title="场景："></a>场景：</h2><p>你可能遇到过类似的情况：同一条数据在多个页面上展示，并且这些页面同时存在，在其中某一个页面上修改数据，其他页面能够及时更新。我在工作当中就遇到了一个类似的场景：我们APP内部做了一个论坛，每条帖子都可以被点赞，可以在列表页点赞也可以在详情页点赞。以前只有一个列表页，一个详情页，所以直接通过startActivityForResult和onActivityResult就可以在返回列表页的时候更新列表页的状态。后来又增加了一个列表页，跟前一个列表页有重复数据，上面的那个方法就玩不转了，只得另外在想办法。本文就是从这个问题出发，提出一个解决同类问题的通用方法。</p>
<h2 id="架构："><a href="#架构：" class="headerlink" title="架构："></a>架构：</h2><p>核心思想：</p>
<ol>
<li><code>借助EventBus构建一个Publish/Subscribe系统</code>；</li>
<li>每个页面就是一个Observer，向EventBus订阅自己感兴趣的事件；</li>
<li>当数据对象（Subject）发生改变，发布（Publish）一个事件出来；</li>
<li>页面接收到事件更新自己持有的数据、修改页面展示。</li>
</ol>
<h2 id="实现："><a href="#实现：" class="headerlink" title="实现："></a>实现：</h2><ol>
<li>事件基类：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEvent</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> String uuid;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseEvent</span><span class="params">(String uuid)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.uuid = uuid;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseEvent</span><span class="params">()</span></span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isMe</span><span class="params">(String me)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(TextUtils.isEmpty(uuid))&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> me.equals(uuid);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>事件样例：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PraiseEvent</span> <span class="keyword">extends</span> <span class="title">BaseEvent</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> String data;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PraiseEvent</span><span class="params">(String uuid,String data)</span></span>&#123;</div><div class="line">        <span class="keyword">super</span>(uuid);</div><div class="line">        <span class="keyword">this</span>.data = data;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>页面处理样例：(这里展示了RecyclerView当中更新数据的做法)</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(PraiseEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = recyclerView.getChildCount()-<span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;count;i++)&#123;</div><div class="line">            View child = recyclerView.getChildAt(i);</div><div class="line">            <span class="keyword">if</span>(child.getTag() != <span class="keyword">null</span>)&#123;</div><div class="line">                ItemViewHolder holder = (ItemViewHolder) child.getTag();</div><div class="line">                <span class="keyword">if</span>(event.isMe(holder.data.getId()))&#123;</div><div class="line">                    Data data = holder.data;</div><div class="line">                    String target = event.data;</div><div class="line">                    <span class="keyword">if</span> (target.equals(data.getIsLike())) &#123;</div><div class="line">                        <span class="keyword">return</span>;</div><div class="line">                    &#125;</div><div class="line">                    data.setIsLike(target);</div><div class="line">                    holder.binding.ivLike.setImageResource(<span class="string">"Y"</span>.equals(data.getIsLike()) ?</div><div class="line">                       R.drawable.ic_like_normal :</div><div class="line">                       R.drawable.ic_like_pressed);</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> size = datas.size();</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;size;i++)&#123;</div><div class="line">            Data data = datas.get(i);</div><div class="line">            <span class="keyword">if</span>(event.isMe(data.getId()))&#123;</div><div class="line">                String target = event.data;</div><div class="line">                <span class="keyword">if</span> (target.equals(data.getIsLike())) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                data.setIsLike(target);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="可能存在的问题："><a href="#可能存在的问题：" class="headerlink" title="可能存在的问题："></a>可能存在的问题：</h2><p>本方案把所有的<code>subscriber</code>都注册到了默认的EventBus实例上，可能会影响性能。如果应用模块划分比较明确，可以为每个模块单独分配一个EventBus实例。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/Android应用内部数据同步/" data-id="cj0uytlfe0005awjh1wroxjg9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-App多渠道打包" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/App多渠道打包/" class="article-date">
  <time datetime="2017-03-27T07:46:30.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/App多渠道打包/">App多渠道打包</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>基本思路：在AndroidManifest.xml文件中设置一个placeholder，打包的时候动态替换该placeholder。</p>
<ol>
<li><p>通过如下方式在AndroidManifest.xml文件中设置一个placeholder（这里placeholder名为“APP_CHANNEL_VALUE”）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">AndroidManifest.xml：</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">"APP_CHANNEL"</span></div><div class="line">    <span class="attr">android:value</span>=<span class="string">"$&#123;APP_CHANNEL_VALUE&#125;"</span> /&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>在build.gradle文件中动态替换placeholder：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">huild.gradle:</div><div class="line">android&#123;</div><div class="line">    ...</div><div class="line">    productFlavors &#123;</div><div class="line">        yingyongbao &#123;&#125;</div><div class="line">        xiaomi &#123;&#125;</div><div class="line">        huawei &#123;&#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    productFlavors.all &#123;</div><div class="line">        flavor -&gt; flavor.manifestPlaceholders = [APP_CHANNEL_VALUE:name]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>经过上述两步操作，执行打包命令<code>gradlew assembleRelease</code>，就能获得不同渠道的安装包了。</p>
<p><code>注意</code></p>
<p>有时，我们在AndroidManifest.xml文件当中配置了多个placeholder，比如我们在上述AndroidManifest.xml中再添加一个placeholder，名字为APP_KEY_VALUE：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">AndroidManifest.xml：</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">"APP_CHANNEL"</span></div><div class="line">    <span class="attr">android:value</span>=<span class="string">"$&#123;APP_CHANNEL_VALUE&#125;"</span> /&gt;</div><div class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">"APP_KEY"</span></div><div class="line">    <span class="attr">android:value</span>=<span class="string">"$&#123;APP_KEY_VALUE&#125;"</span> /&gt;</div></pre></td></tr></table></figure>
<p>这时会报这样的问题：</p>
<blockquote>
<p>Error:(74, 13) Attribute meta-data#APP_KEY@value at AndroidManifest.xml:74:13 requires a placeholder substitution but no value for <app_key> is provided.</app_key></p>
</blockquote>
<p>问题的原因是没有为APP_KEY_VALUE提供值。下面我们尝试修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">huild.gradle:</div><div class="line">android&#123;</div><div class="line">    defaultConfig &#123;</div><div class="line">        manifestPlaceholders = [APP_KEY_VALUE : &quot;appkey&quot;]</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    productFlavors &#123;</div><div class="line">        yingyongbao &#123;&#125;</div><div class="line">        xiaomi &#123;&#125;</div><div class="line">        huawei &#123;&#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    productFlavors.all &#123;</div><div class="line">        flavor -&gt; flavor.manifestPlaceholders = [APP_CHANNEL_VALUE:name]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样修改之后问题依然存在。我们看一下这个问题的原因：</p>
<p>manifestPlaceholders是一个变量，我们在defaultConfig当中赋值，又在productFlavor.all中赋值，前面的赋值就被覆盖掉了。<br>进一步讲，manifestPlaceholders是一个数组变量，赋值的时候我们应该把所有placeholder组成一个数组赋值给manifestPlaceholders。</p>
<p>正确的做法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">huild.gradle:</div><div class="line">android&#123;</div><div class="line">    ...</div><div class="line">    productFlavors &#123;</div><div class="line">        yingyongbao &#123;&#125;</div><div class="line">        xiaomi &#123;&#125;</div><div class="line">        huawei &#123;&#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    productFlavors.all &#123;</div><div class="line">        flavor -&gt; flavor.manifestPlaceholders = [APP_CHANNEL_VALUE:name，</div><div class="line">                                                  APP_KEY_VALUE:&quot;appkey&quot;]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="进阶-gt-配置文件外移"><a href="#进阶-gt-配置文件外移" class="headerlink" title="进阶-&gt;配置文件外移"></a>进阶-&gt;配置文件外移</h2><p>在根目录下创建<code>local.properties</code>文件，并添加如下内容：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">local.properties</div><div class="line"></div><div class="line">sdk.dir = /android/sdk/dir</div><div class="line">appkey:"realAppkey"</div></pre></td></tr></table></figure></p>
<p>在build.gradle文件中引用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">huild.gradle:</div><div class="line"></div><div class="line">apply plugin: &apos;com.android.application&apos;</div><div class="line"></div><div class="line">Properties properties = new Properties()</div><div class="line">properties.load(project.rootProject.file(&apos;local.properties&apos;).newDataInputStream())</div><div class="line"></div><div class="line">android&#123;</div><div class="line">    ...</div><div class="line">    productFlavors &#123;</div><div class="line">        yingyongbao &#123;&#125;</div><div class="line">        xiaomi &#123;&#125;</div><div class="line">        huawei &#123;&#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    productFlavors.all &#123;</div><div class="line">        flavor -&gt; flavor.manifestPlaceholders = [APP_CHANNEL_VALUE:name，</div><div class="line">                                                  APP_KEY_VALUE:properties.getProperty(&quot;appkey&quot;)]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="偷懒的做法"><a href="#偷懒的做法" class="headerlink" title="偷懒的做法"></a>偷懒的做法</h2><p>360提供了一个工具包，使用这个工具包可以对应用进行批量操作。大概原理应该是解包，修改，重新打包。使用比较傻瓜，具体请自行研究。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/App多渠道打包/" data-id="cj0uytlfg0006awjhmi4330js" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-EditText整体hint" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/EditText整体hint/" class="article-date">
  <time datetime="2017-03-27T07:46:30.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/EditText整体hint/">EditText整体hint</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>研究b站app的时候发现了一个之前没有见过的效果，于是研究了一下。下面是b站的效果：<br><img src="../assets/hint1.gif" width="360/"></p>
<p>在上面这个过程中，我发现：</p>
<p>1.输入框中包含了两个部分的内容，前面带背景的部分A和后面正常输入的部分B；</p>
<p>2.点击删除的时候，正常输入的部分B也是被正常删除的，但是带背景的部分A则是被作为整体删除的。</p>
<p>奈何小生我学习不认真，竟然没有看懂这当中的门道，一度以为这个效果特别高端，还怀疑是通过自定义控件实现的。但是当我查看了EditText&amp;TextView的源码，我肯定他们没有自定义控件（这么复杂的逻辑，他们做不来！）。一定是我忽略了什么东西！</p>
<p>一边看源码，一边问同事，终于让我发现了真相！</p>
<p>如果你抢答“BackgroundColorSpan”，我只能很遗憾的告诉你“回答错误”。少侠，拳头放下，有话咱们好好说。这个地方确实使用了Span，但并不是BackgroundColorSpan，而是ImageSpan。客官，你先喝口热翔，容我跟你分说端详。</p>
<p>第一个问题，为什么BackgroundColorSpan不能胜任？用BackgroundColorSpan能够实现第一特征，为部分文字添加背景，但仅仅是添加背景。这些文字还是各自独立的，不会被当作一个整体来处理，也就是说第二个特征不满足，点击删除的时候还会逐字删除。还有一个不能忍的地方，光标会定位到前半部分的中间。第二个问题，为什么ImageSpan可以？想到了罗老师的一句话，彪悍的人生不需要解释！为什么可以，就是因为我能干！戴好墨镜，我要上图了（你们不要邪恶好不好）。</p>
<p><img src="../assets/hint2.gif" width="360/"></p>
<p>前面是在windows上做的，后面是在mac上做的（我是不是高端黑？是ps软件版本的问题，不是我大苹果的问题）。</p>
<p>咱们接着鬼扯，提到ImageSpan我们首先想到的是，在文字边上加图片。但这个地方，我们直观的感觉是，这个地方是文本呀！不是图片呀！！！我们换一个角度来考虑这个问题，我们觉得不对劲只是因为跟我们的习惯或者感觉冲突了，我们的习惯和感觉就是对的嘛？我们站在用户的角度来想，我看到了这些内容，我并不关心你放的是文本还是图片。so——这根本就不是个问题！不要怂，就是干！再点击删除键的时候，ImageSpan只相当于一个字符，图片被删除了上面的文字自然全部消失了！第二个特征满足！至于第一个特征，我相信，聪慧如你，自然不是问题！</p>
<p>完结，撒花！</p>
<p>参考文章：</p>
<ul>
<li><a href="http://blog.sina.com.cn/s/blog_618199e60101rfw5.html" target="_blank" rel="external">《Android textView 添加超链接(三种实现方式）》</a></li>
<li><a href="http://hunankeda110.iteye.com/blog/1420470" target="_blank" rel="external">《android中的spannable的使用》</a></li>
<li><a href="http://www.cnblogs.com/nokiaguy/archive/2011/10/06/2199775.html" target="_blank" rel="external">《Android开发技巧：像QQ一样输入表情图像》</a></li>
<li><a href="http://blog.csdn.net/djcken/article/details/41898523" target="_blank" rel="external">《关于Android使用TextView+ImageSpan同一行文字图片居中的问题》</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/EditText整体hint/" data-id="cj0uytlfh0007awjhlud4fx3h" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Handler的执行时机" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/Handler的执行时机/" class="article-date">
  <time datetime="2017-03-27T07:46:30.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/Handler的执行时机/">Handler的执行时机</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Handler的执行时机"><a href="#Handler的执行时机" class="headerlink" title="Handler的执行时机"></a>Handler的执行时机</h2><p>“Handler是否会阻塞主线程？”本篇文章即是对这个问题的回答。</p>
<p>我们先来补充一下基础知识:<br><br><a href="http://blog.csdn.net/bboyfeiyu/article/details/39136313" target="_blank" rel="external">《Android View系统分析之三Activity的启动与显示》</a><br><br><a href="http://blog.csdn.net/u013435893/article/details/50903082" target="_blank" rel="external">《Android中为什么主线程不会因为Looper.loop()方法造成阻塞》</a><br><br>阅读上面两篇文章，我们了解到，ActivityThread内部在启动之初就开始了一个Looper循环，Android应用程序中所有在UI线程任务都是在这个Looper循环内部完成的。即Android程序的主体就是Looper循环，当Looper循环退出时，进程就应该结束了。</p>
<p>又到了大家最喜欢的“看程序，写输出”环节(笔试题)，分析下面的Android代码，写输出。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        <span class="comment">//布局文件中没有内容不用理会</span></div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        handelr.sendEmptyMessage(<span class="number">1</span>);</div><div class="line">        handelr.sendEmptyMessage(<span class="number">2</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStart();</div><div class="line">        System.out.println(<span class="string">"onStart"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onResume();</div><div class="line">        System.out.println(<span class="string">"onResume"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//这里不做内存泄漏处理了，请自行处理</span></div><div class="line">    <span class="keyword">private</span> Handler handelr = <span class="keyword">new</span> Handler()&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what)&#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    System.out.println(<span class="string">"first"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    System.out.println(<span class="string">"second"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上述Activity是应用程序的启动Activity，请问启动应用之后的输出？<br><br>输出结果是什么？你造吗？<br><br>经过老夫实际测试，输出结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">onStart</div><div class="line">onResume</div><div class="line">first</div><div class="line">second</div></pre></td></tr></table></figure></p>
<p>你答对了吗？</p>
<p>反正结果跟我的答案有出入，这让我很不爽，reading the fucking source code！</p>
<p>我们的目的是理清<code>Activity启动时的时序</code>。看上面的文章了解Activity的启动过程，我们发现一个Activity诞生于handleLaunchActivity方法，我们以此作为入口，进行探查。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//仅列出本文相关代码</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    Activity a = performLaunchActivity(r, customIntent);</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</div><div class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，在handleLaunchActivity方法中先后调用了<code>performLaunchActivity</code>和<code>handleResumeActivity</code>两个方法。第一个有待进一步梳理，第二个方法已经比较明了了，对应的就是Activity的onResume方法。那么现在的一个时序就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">performLaunchActivity &gt;&gt; handleResumeActivity</div></pre></td></tr></table></figure>
<p>我们近一步探查performLaunchActivity：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//仅列出本文相关代码</span></div><div class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    Activity activity = <span class="keyword">null</span>;</div><div class="line">    java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">    activity = mInstrumentation.newActivity(</div><div class="line">            cl, component.getClassName(), r.intent);</div><div class="line">    ...</div><div class="line">    mInstrumentation.callActivityOnCreate(activity, r.state);</div><div class="line">    ...</div><div class="line">    activity.performStart();</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> activity;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看到这里你一定能看出来了，在performLaunchActivity，也是先后调用了两个Activity生命周期相关的方法<code>mInstrumentation.callActivityOnCreate</code>和<code>activity.performStart</code>，对应的分别是Activity中的onCreate方法和onStart方法。那么我们完善之后的时序就是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">callActivityOnCreate &gt;&gt; performStart &gt;&gt; handleResumeActivity</div></pre></td></tr></table></figure></p>
<p>小伙伴，你看明白了吗？Activity启动的时候，这三个方法并不是通过调用三次sendMessage的分三次调用，而是在handleLaunchActivity中逐个调用。根据Handler的执行规则，当前Message被处理完成之后才会处理MessageQueue中下一个Message，所以我们在onCreate中发出的消息必须等到handleLaunchActivity执行完，才会被处理。然后，按FIFO的规则处理两个消息：fist，second。</p>
<p>综上，<font color="#ff3131">Handler确实能够避免阻塞UI线程的作用，它只是把消息放入MessageQueue中不一定立即执行。同时我们也要知道，如果Handler内部handleMessage方法执行耗时操作的话，UI线程是会被阻塞的！</font></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/Handler的执行时机/" data-id="cj0uytlfm0008awjho3rwbb9j" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ImageView中Bitmap的回收" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/ImageView中Bitmap的回收/" class="article-date">
  <time datetime="2017-03-27T07:46:30.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/ImageView中Bitmap的回收/">ImageView中Bitmap的回收</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>下面是回收ImageView持有的Bitmap的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * 回收bitmap</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recycleBitmap</span><span class="params">(ImageView iv)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (iv != <span class="keyword">null</span> &amp;&amp; iv.getDrawable() != <span class="keyword">null</span>) &#123;</div><div class="line">       BitmapDrawable bitmapDrawable = (BitmapDrawable) iv.getDrawable();</div><div class="line">       iv.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">       <span class="keyword">if</span> (bitmapDrawable != <span class="keyword">null</span>) &#123;</div><div class="line">           Bitmap bitmap = bitmapDrawable.getBitmap();</div><div class="line">           <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">               bitmap.recycle();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>两点解释：</p>
<ol>
<li><p>为什么是setImageDrawable(null)?</p>
<p>setImageBitmap(Bitmap bitmap)实质上是调用setImageDrawable(Drawable drawable)，</p>
<p>而setImageDrawable(Drawable drawable)最终调用updateDrawable(Drawable d)完成mDrawable的赋值。</p>
</li>
<li><p>为什么不能直接设置bitmap=null?</p>
<p>Bitmap类的构造方法都是私有的，所以开发者不能直接new出一个Bitmap对象，只能通过BitmapFactory类的各种静态方法来实例化一个Bitmap.仔细查看BitmapFactory的源代码可以看到，生成Bitmap对象最终都是通过JNI调用方式实现的。所以，加载Bitmap到内存里以后，是包含两部分内存区域的。简单的说，一部分是Java部分的，一部分是C部分的。这个Bitmap对象是由Java部分分配的，不用的时候系统就会自动回收了，但是那个对应的C可用的内存区域，虚拟机是不能直接回收的，这个只能调用底层的功能释放。所以需要调用recycle()方法来释放C部分的内存。从Bitmap类的源代码也可以看到，recycle()方法里也的确是调用了JNI方法了的。</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/ImageView中Bitmap的回收/" data-id="cj0uytlfo0009awjhyegu3jif" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Java中继承类的初始化顺序" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/Java中继承类的初始化顺序/" class="article-date">
  <time datetime="2017-03-27T07:46:30.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/Java中继承类的初始化顺序/">Java中继承类的初始化顺序</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>人没钱不如鬼，汤没盐不如水。慢慢你会发现，一颗好心永远比不上一张好嘴。</p>
<p>本文转载自：<a href="http://blog.csdn.net/zhangjk1993/article/details/24066085" target="_blank" rel="external">《java静态绑定与动态绑定》</a><br>程序绑定的概念：</p>
<blockquote>
<p>绑定指的是一个方法的调用与方法所在的类（方法主体）关联起来。对java来说，绑定分为静态绑定和动态绑定；或者叫做前期绑定和后期绑定。</p>
</blockquote>
<p>静态绑定：<br>在程序执行前方法已经被绑定(也就是说在变异过程中就已经知道这个方法到底是哪个类中的方法)，由编译器或其它连接程序实现。针对java简单的可以理解为程序编译器的绑定；这里特别说明一点，java当中的方法只有final，static，private和构造方法是前期绑定。<br>动态绑定：<br>后期绑定：在运行时根据具体对象的类型进行绑定。<br>若一种语言实现了后期绑定，必须同时提供一些机制，可在运行期间判断对象的类型，并分别调用适当的方法。也就是说，编译器此时依然不知道对象的类型，但方法调用机制自己能去调查，找到真缺德方法主体。不同的语言对于后期绑定的是想方法是有所区别的。但我们至少可以这样认为：它们都要在对象中安插某些特殊类型的信息。</p>
<p>动态绑定的过程：</p>
<ol>
<li>虚拟机提取对象的实际类型的方法表；</li>
<li>虚拟机搜索方法签名；</li>
<li>调用方法。</li>
</ol>
<p>关于final、static、private和构造方法是前期绑定的理解<br>对于private的方法，首先一点它不能被继承，既然不能被继承那么就没有办法通过它子类的对象来调用，而只能通过这个类自身的对象来调用。因此就可以说private方法和定义这个方法的类绑定在了一起。</p>
<p>final方法虽然可以被继承，但不能被重写，虽然子类对象可以调用，但是调用的都是弗雷中所定义的那个final方法，（由此我们可以知道将方法声明为final类型，一是为了防止方法被覆盖，二是为了有效的关闭java中的动态绑定）。<br>构造绑法也是不能被继承的，因此便意识也可以知道这个构造方法到底属于哪一个类。</p>
<p>对于static方法，具体的原理我也说不太清楚。不过根据网上的资料和我自己做的实验可以得出结论：static方法可以被子类继承，但是不能被子类重写，但是可以被子类隐藏。（这里的意思是说，如果父类中有一个static方法，它的子类里如果没有对应的方法，那么当子类对象调用这个方法时就会使用父类的方法。而如果子类中定义了相同的方法，则会调用子类中定义的方法。唯一的不同就是，当子类对象上转型为父类对象时，不论子类中有没有定义这个静态方法，该对象都会使用父类中的静态方法。因此这里说静态方法可以被隐藏而不能被覆盖。这与子类隐藏父类中的成员变量是一样的。隐藏和覆盖的区别在于，子类对象转换成父类对象之后，狗狗访问父类被隐藏的变量和方法，而不能访问父类被覆盖的方法）</p>
<p>由上面我们可以得出一个结论，如果一个方法不可被继承或者继承后不可被覆盖，那么这个方法就采用的静态绑定。</p>
<p>java的编译与运行</p>
<p>java的编译过程是将java源文件编译成字节码（jvm可执行文件，即class文件）的过程，在这个过程中java是不与内存打交道的，在这个过程中编译器会进行语法的分析，如果语法不正确就会报错。</p>
<p>java的运行过程是指jvm装载字节码文件并解释执行。在这个过程才是真正的创立内存布局，执行java程序。</p>
<p>java字节码的执行有两种方式：（1）即时编译方式：编译器先将字节编译成及其码，然后再执行该机器码；（2） 解释执行方式：解释器通过每次解释并执行一小段代码来完成java字节码程序的所有操作。（这里我们可以看出java程序在执行过程中其实进行了两次转换，线转换成字节码再转换成机器码。这也证实java能一次编译，到处运行的原因。在不同的平台上装上对应的java虚拟机，就可以是想相同字节码装换乘不同平台上的机器码，从而在不同的平台上运行）</p>
<p>前面已经说了对于java当中的方法而言，除了final，static，private和构造方法是前期绑定外，其他的方法全部为动态绑定。</p>
<p>而动态绑定的典型发生在父类子类的转换声明之下：<br>比如：Parent p = new Children();</p>
<p>其具体过程细节如下：</p>
<ol>
<li><p>编译器检查对象的声明类型和方法名。<br>假设我们调用x.f(args)，并且x已经被声明为C类的对象，那么编译器就会列举出C类中所有的名称为f的方法和从C的超类继承过来的f方法。</p>
</li>
<li><p>接下来编译器检查方法调用中提供的参数类型。<br>如果在所有名称为f的方法中有一个参数类型和调用提供的参数类型最为匹配那么就调用这个方法，这个过程叫做“重载解析”。</p>
</li>
<li><p>当程序运行并且使用动态绑定调用方法时，虚拟机必须调用同x所只想的实际类型相匹配的方法版本。</p>
</li>
</ol>
<p>假设实际类型为D(C的子类)，如果D类定义了f(String)那么该方法被调用，否则就在D的超类中搜寻方法f(String)以此类推。</p>
<p>jvm调用一个类方法是(静态方法)，它会基于对象引用的类型（通常在编译时可知）来选择所调用的方法。相反，当虚拟机调用一个实例方法时，它会基于对象实际的类型（只能在运行时得知）来选择所调用的方法，这就是动态绑定，是多态的一种。动态绑定为解决实际的业务问题提供了很大的灵活性，是一种非常优美的机制。</p>
<p>与方法不同，在处理java类中的成员变量(实例变量和类变量)时，并不是采用运行时绑定，而是一般意义上的静态绑定。所以在向上转换的情况下，对象的方法可以找到子类，而对象的属性（成员变量）还是父类的属性（子类对父类成员变量的隐藏）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Father</span> </span>&#123;  </div><div class="line">    <span class="keyword">protected</span> String name = <span class="string">"父亲属性"</span>;  </div><div class="line">&#125;  </div><div class="line">　　  </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Son</span> <span class="keyword">extends</span> <span class="title">Father</span> </span>&#123;  </div><div class="line">    <span class="keyword">protected</span> String name = <span class="string">"儿子属性"</span>;  </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </div><div class="line">        Father sample = <span class="keyword">new</span> Son();  </div><div class="line">        System.out.println(<span class="string">"调用的属性："</span> + sample.name);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结论，调用的成员为父亲的属性。</p>
<p>这个结果表明，子类的对象(由父类的引用handle)调用的是父类的成员变量。所以必须明确，运行时（动态）绑定针对的范畴只是对象的方法。现在试图调用子类的成员变量name，该怎么做？最简单的方法是将该成员变量封装成方法getter形式。</p>
<p>代码如下：<br>java代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Father</span> </span>&#123;  </div><div class="line">    <span class="keyword">protected</span> String name = <span class="string">"父亲属性"</span>;  </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> name;  </div><div class="line">    &#125;  </div><div class="line">&#125;　　  </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Son</span> <span class="keyword">extends</span> <span class="title">Father</span> </span>&#123;  </div><div class="line">    <span class="keyword">protected</span> String name = <span class="string">"儿子属性"</span>;  </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> name;  </div><div class="line">    &#125;  </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </div><div class="line">        Father sample = <span class="keyword">new</span> Son();  </div><div class="line">        System.out.println(<span class="string">"调用的属性:"</span> + sample.getName());  </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果：调用的是儿子的属性<br>java因为什么对属性要采取静态的绑定方法呢？这是因为静态绑定有很多的好处，它可以让我们在编译期就发现程序中的错误，而不是在运行期。这样就可以提高程序的运行效率！而对方法采取动态绑定是为了实现多态，多态是java的一大特色。多态也是面向对象的关键技术之一，所以java以效率为代价来实现多态是很值得的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/Java中继承类的初始化顺序/" data-id="cj0uytlfq000aawjheaceug2c" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Android WebView以post方式加载url" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/Android WebView以post方式加载url/" class="article-date">
  <time datetime="2017-03-27T07:46:30.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/Android WebView以post方式加载url/">Android WebView以POST方式加载URL</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一般情况下，调用WebView.loadUrl(url)方法即可加载需要展示的Html页面了，如果需要传参数的话，我们也可以把参数拼在url后面(像这样<a href="http://www.baidu.com/s?word=WebView" target="_blank" rel="external">http://www.baidu.com/s?word=WebView</a>)，一并传给服务端。但有时候情况比较特殊，比方说，请求页面的时候我们还想通过post方式传一些参数过去，这个时候直接调用上述方法就不行了。这个时候该怎么办呢？</p>
<p>这里讲一个开发中的小技巧，当你面对一个功能一筹莫展的时候，不妨过一遍相关类的API，看到名字跟你目标有点相关性的就点进去看看，没准有现成的API实现呢！</p>
<p>这里看一下WebView的API：<br><img src="assets/webview_posturl.png"><br>看到了一个方法叫postUrl(url,postData),看方法名跟我们的目标比较接近，再看一参数，url+postData不就是地址+数据吗？看到这里已经七七八八了，应该就是这货。然后我们点进去，看一下方法的介绍。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//android.webkit.WebView.class</span></div><div class="line"><span class="comment">/**</span></div><div class="line">  * Loads the URL with postData using "POST" method into this WebView. If url</div><div class="line">  * 通过POST方法加载URL，并携带postData</div><div class="line">  * is not a network URL, it will be loaded with &#123;<span class="doctag">@link</span> #loadUrl(String)&#125;</div><div class="line">  * instead, ignoring the postData param.</div><div class="line">  *</div><div class="line">  * <span class="doctag">@param</span> url the URL of the resource to load</div><div class="line">  * <span class="doctag">@param</span> postData the data will be passed to "POST" request, which must be</div><div class="line">  * "application/x-www-form-urlencoded" encoded.</div><div class="line">  * 通过POST传递的数据必须先使用"application/x-www-form-urlencoded"编码</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postUrl</span><span class="params">(String url, <span class="keyword">byte</span>[] postData)</span> </span>&#123;</div><div class="line">     checkThread();</div><div class="line">     <span class="keyword">if</span> (URLUtil.isNetworkUrl(url)) &#123;</div><div class="line">         mProvider.postUrl(url, postData);</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         mProvider.loadUrl(url);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>看到这里就可以确认，确实是这货。下面我们就看一下怎么使用这个方法。</p>
<p>第一个参数URL没有问题，就是我们要请求的地址；第二个参数postData是要传递的数据，有点麻烦。方法注释（少年一定要好好看注释呀）里面给了我们提示：传递的数据必须先使用”application/x-www-form-urlencoded”编码。然后我们就看看application/x-www-form-urlencoded编码应该长成什么样子。</p>
<p>编码前数据是这个样子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nickName=Micheal Jack&amp;name=张全蛋</div></pre></td></tr></table></figure></p>
<p>编码后数据变成了酱紫：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nickName=Micheal+Jack&amp;name=%E5%BC%A0%E5%85%A8%E8%9B%8B</div></pre></td></tr></table></figure></p>
<p>你一定在吐槽了：who care！快把你的代码交出来，你就可以去领盒饭了！</p>
<p>ok，下面就献上我的代码，大家慢用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by travis on 2017/3/9.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">        User user = <span class="keyword">new</span> User();</div><div class="line">        user.name = <span class="string">"张全蛋"</span>;</div><div class="line">        user.nickName=<span class="string">"Micheal Jack"</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.print(concatParams(getAllFields(user)));</div><div class="line">        &#125;<span class="keyword">catch</span> (UnsupportedEncodingException e)&#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Map&lt;String,String&gt; <span class="title">getAllFields</span><span class="params">(T t)</span></span>&#123;</div><div class="line">        Field[] field = t.getClass().getDeclaredFields();</div><div class="line">        Map&lt;String,String&gt; fieldsAndValues = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; field.length; i++) &#123;</div><div class="line">                String name = field[i].getName();</div><div class="line">                <span class="keyword">if</span>(field[i].getGenericType().toString().equals(<span class="string">"class java.lang.String"</span>))&#123;</div><div class="line">                    String value = (String) field[i].get(t);</div><div class="line">                    fieldsAndValues.put(name,value);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        System.out.print(<span class="string">""</span>+fieldsAndValues.size());</div><div class="line">        <span class="keyword">return</span> fieldsAndValues;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">concatParams</span><span class="params">(Map&lt;String,String&gt; params)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</div><div class="line">        <span class="keyword">if</span>(params.size() ==<span class="number">0</span>)&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</div><div class="line">        Set&lt;String&gt; keys = params.keySet();</div><div class="line">        Iterator&lt;String&gt; iterator = keys.iterator();</div><div class="line">        <span class="keyword">while</span> (iterator.hasNext())&#123;</div><div class="line">            String key = iterator.next();</div><div class="line">            String value = URLEncoder.encode(params.get(key), <span class="string">"UTF-8"</span>);</div><div class="line">            builder.append(String.format(<span class="string">"%s=%s&amp;"</span>,key, value));</div><div class="line">        &#125;</div><div class="line">        builder.deleteCharAt(builder.lastIndexOf(<span class="string">"&amp;"</span>));</div><div class="line">        <span class="keyword">return</span> builder.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</div><div class="line">        String name;</div><div class="line">        String nickName;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这么简单的东西也被我写了这么长，我真是越来越厉害了！(•̀ᴗ•́)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/Android WebView以post方式加载url/" data-id="cj0uytlf00000awjhp82xe5tx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/03/28/Java动态代理Proxy/">Java动态代理Proxy</a>
          </li>
        
          <li>
            <a href="/2017/03/28/PhotoView使用过程中遇到的坑/">PhotoView使用过程中的坑</a>
          </li>
        
          <li>
            <a href="/2017/03/27/Looper和Handler类/">Looper和Handler类</a>
          </li>
        
          <li>
            <a href="/2017/03/27/Android布局文件中的onClick属性/">Android布局文件中的onClick属性</a>
          </li>
        
          <li>
            <a href="/2017/03/27/Android应用内开新进程的一些行为记录/">Android应用内开新进程的一些行为记录</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Travis<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>